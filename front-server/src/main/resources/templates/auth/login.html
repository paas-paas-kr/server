<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ - ë‹¤ë¬¸í™” ê°€ì • ìƒë‹´ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="auth-logo-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <h1 class="auth-title">ë‹¤ì‹œ ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”!</h1>
                <p class="auth-subtitle">ë‹¤ë¬¸í™” ê°€ì •ì„ ìœ„í•œ AI ìƒë‹´ ì„œë¹„ìŠ¤</p>
            </div>

            <form class="auth-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="email">ì´ë©”ì¼ / Email</label>
                    <input type="email" id="email" class="form-input" placeholder="your@email.com" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">ë¹„ë°€ë²ˆí˜¸ / Password</label>
                    <input type="password" id="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>

                <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸ / Login</button>
            </form>

            <div class="auth-link">
                ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? / Don't have an account? <br>
                <a th:href="@{/auth/signup}">íšŒì›ê°€ì… / Sign up</a>
            </div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/i18n.js"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì–¸ì–´ ì ìš© ë° ë¡œê·¸ì¸ ì²´í¬
        document.addEventListener('DOMContentLoaded', function() {
            // ì–¸ì–´ ì ìš©
            if (window.i18n) {
                window.i18n.updatePageLanguage();
            }

            // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ í™ˆìœ¼ë¡œ ì´ë™
            const isLoggedIn = localStorage.getItem('isLoggedIn');

            if (isLoggedIn === 'true') {
                window.location.href = '/home';
            }
        });

        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            console.log('ğŸ” ë¡œê·¸ì¸ ì‹œì‘:', email);

            try {
                // ì‹¤ì œ API í˜¸ì¶œ
                console.log('ğŸ“¤ API í˜¸ì¶œ:', `${window.API_BASE_URL}/api/auth/login`);
                const response = await fetch(`${window.API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    }),
                    credentials: 'include'
                });

                console.log('ğŸ“¥ ë¡œê·¸ì¸ ì‘ë‹µ ìƒíƒœ:', response.status);
                const result = await response.json();
                console.log('ğŸ“¥ ë¡œê·¸ì¸ ì‘ë‹µ ë°ì´í„°:', result);

                if (!response.ok) {
                    console.error('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:', result.error);
                    const errorMsg = getErrorMessage(result.error || 'login.error.failed');
                    alert(errorMsg);
                    return;
                }

                // JWT í† í° ì €ì¥
                if (result.data && result.data.accessToken) {
                    const token = result.data.accessToken;
                    localStorage.setItem('accessToken', token);
                    console.log('âœ… JWT í† í° ì €ì¥ ì™„ë£Œ');

                    console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ, ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì¤‘...');
                    // ë‚´ ì •ë³´ ì¡°íšŒ
                    const meResponse = await fetch(`${window.API_BASE_URL}/api/auth/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        credentials: 'include'
                    });

                    console.log('ğŸ“¥ /me ì‘ë‹µ ìƒíƒœ:', meResponse.status);

                    if (meResponse.ok) {
                        const meResult = await meResponse.json();
                        const userInfo = meResult.data;
                        console.log('âœ… ì‚¬ìš©ì ì •ë³´:', userInfo);

                        localStorage.setItem('userInfo', JSON.stringify({
                            name: userInfo.name,
                            email: userInfo.email,
                            preferredLanguage: userInfo.preferredLanguage
                        }));
                        localStorage.setItem('isLoggedIn', 'true');

                        // ì‚¬ìš©ìì˜ ì„ í˜¸ ì–¸ì–´ ì„¤ì •
                        if (userInfo.preferredLanguage) {
                            const langMap = {
                                'ko': 'í•œêµ­ì–´',
                                'en': 'English',
                                'zh': 'ä¸­æ–‡',
                                'vi': 'Tiáº¿ng Viá»‡t',
                                'ja': 'æ—¥æœ¬èª'
                            };
                            const langName = langMap[userInfo.preferredLanguage] || 'í•œêµ­ì–´';
                            localStorage.setItem('language', langName);
                        }

                        // í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™
                        console.log('ğŸ  í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™:', '/home');
                        window.location.href = '/home';
                    } else {
                        console.error('âŒ /me í˜¸ì¶œ ì‹¤íŒ¨:', meResponse.status);
                        const meError = await meResponse.text();
                        console.error('ì—ëŸ¬ ë‚´ìš©:', meError);
                        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    console.error('âŒ result.dataê°€ ì—†ìŒ:', result);
                    alert('ë¡œê·¸ì¸ ì‘ë‹µì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ Login error:', error);
                const errorMsg = getErrorMessage('login.error.network');
                alert(errorMsg);
            }
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ ë‹¤êµ­ì–´ ì²˜ë¦¬
        function getErrorMessage(key) {
            const messages = {
                'login.error.failed': {
                    'ko': 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                    'en': 'Email or password is incorrect.',
                    'vi': 'Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng.',
                    'zh': 'ç”µå­é‚®ä»¶æˆ–å¯†ç ä¸æ­£ç¡®ã€‚',
                    'ja': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'
                },
                'login.error.network': {
                    'ko': 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                    'en': 'Login failed. Please try again.',
                    'vi': 'ÄÄƒng nháº­p tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.',
                    'zh': 'ç™»å½•å¤±è´¥ã€‚è¯·é‡è¯•ã€‚',
                    'ja': 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                }
            };

            const lang = window.i18n ? window.i18n.getLanguageCode(window.i18n.getCurrentLanguage()) : 'ko';
            return messages[key]?.[lang] || messages[key]?.['ko'] || key;
        }
    </script>
</body>
</html>

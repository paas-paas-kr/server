<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì›ê°€ì… - ë‹¤ë¬¸í™” ê°€ì • ìƒë‹´ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="auth-logo-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                </div>
                <h1 class="auth-title">í•¨ê»˜ ì‹œì‘í•´ìš”!</h1>
                <p class="auth-subtitle">ë‹¤ë¬¸í™” ê°€ì •ì„ ìœ„í•œ AI ìƒë‹´ ì„œë¹„ìŠ¤</p>
            </div>

            <form class="auth-form" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <label class="form-label" for="name">ì´ë¦„ / Name</label>
                    <input type="text" id="name" class="form-input" placeholder="í™ê¸¸ë™ / Your name" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">ì´ë©”ì¼ / Email</label>
                    <input type="email" id="email" class="form-input" placeholder="your@email.com" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">ë¹„ë°€ë²ˆí˜¸ / Password</label>
                    <input type="password" id="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ / Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="preferredLanguage">ì„ í˜¸ ì–¸ì–´ / Preferred Language</label>
                    <select id="preferredLanguage" class="form-input" required>
                        <option value="KOREAN">í•œêµ­ì–´ (Korean)</option>
                        <option value="ENGLISH">English</option>
                        <option value="CHINESE">ä¸­æ–‡ (Chinese)</option>
                        <option value="VIETNAMESE">Tiáº¿ng Viá»‡t (Vietnamese)</option>
                        <option value="JAPANESE">æ—¥æœ¬èª (Japanese)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">íšŒì›ê°€ì… / Sign up</button>
            </form>

            <div class="auth-link">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? / Already have an account? <br>
                <a th:href="@{/auth/login}">ë¡œê·¸ì¸ / Login</a>
            </div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/i18n.js"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì–¸ì–´ ì ìš© ë° ë¡œê·¸ì¸ ì²´í¬
        document.addEventListener('DOMContentLoaded', function() {
            // ì–¸ì–´ ì ìš©
            if (window.i18n) {
                window.i18n.updatePageLanguage();
            }

            // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ í™ˆìœ¼ë¡œ ì´ë™
            const isLoggedIn = localStorage.getItem('isLoggedIn');

            if (isLoggedIn === 'true') {
                window.location.href = '/home';
            }
        });

        async function handleSignup(event) {
            event.preventDefault();

            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const preferredLanguage = document.getElementById('preferredLanguage').value;

            if (password !== confirmPassword) {
                const errorMsg = getErrorMessage('signup.error.password_mismatch');
                alert(errorMsg);
                return;
            }

            if (password.length < 8) {
                const errorMsg = getErrorMessage('signup.error.password_length');
                alert(errorMsg);
                return;
            }

            console.log('ğŸ“ íšŒì›ê°€ì… ì‹œì‘:', email);

            try {
                // ì‹¤ì œ API í˜¸ì¶œ
                console.log('ğŸ“¤ API í˜¸ì¶œ:', `${window.API_BASE_URL}/api/auth/signup`);
                const response = await fetch(`${window.API_BASE_URL}/api/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        name: name,
                        preferredLanguage: preferredLanguage
                    }),
                    credentials: 'include'
                });

                console.log('ğŸ“¥ íšŒì›ê°€ì… ì‘ë‹µ ìƒíƒœ:', response.status);
                const result = await response.json();
                console.log('ğŸ“¥ íšŒì›ê°€ì… ì‘ë‹µ ë°ì´í„°:', result);

                if (!response.ok) {
                    console.error('âŒ íšŒì›ê°€ì… ì‹¤íŒ¨:', result.error);
                    let errorMsg = result.error || 'signup.error.failed';

                    // ì—ëŸ¬ ë©”ì‹œì§€ê°€ í•œê¸€ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ ë²ˆì—­
                    if (errorMsg.includes('ì´ë¯¸ ê°€ì…ëœ')) {
                        errorMsg = getErrorMessage('signup.error.duplicate');
                    } else if (!errorMsg.includes('.')) {
                        errorMsg = getErrorMessage(errorMsg);
                    }

                    alert(errorMsg);
                    return;
                }

                console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ, ìë™ ë¡œê·¸ì¸ ì¤‘...');
                // íšŒì›ê°€ì… ì„±ê³µ í›„ ìë™ ë¡œê·¸ì¸
                const loginResponse = await fetch(`${window.API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    }),
                    credentials: 'include'
                });

                console.log('ğŸ“¥ ë¡œê·¸ì¸ ì‘ë‹µ ìƒíƒœ:', loginResponse.status);

                if (loginResponse.ok) {
                    const loginResult = await loginResponse.json();
                    console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ, ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì¤‘...');

                    // JWT í† í° ì €ì¥
                    if (loginResult.data && loginResult.data.accessToken) {
                        const token = loginResult.data.accessToken;
                        localStorage.setItem('accessToken', token);
                        console.log('âœ… JWT í† í° ì €ì¥ ì™„ë£Œ');

                        // ë‚´ ì •ë³´ ì¡°íšŒ
                        const meResponse = await fetch(`${window.API_BASE_URL}/api/auth/me`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            credentials: 'include'
                        });

                    console.log('ğŸ“¥ /me ì‘ë‹µ ìƒíƒœ:', meResponse.status);

                    if (meResponse.ok) {
                        const meResult = await meResponse.json();
                        const userInfo = meResult.data;
                        console.log('âœ… ì‚¬ìš©ì ì •ë³´:', userInfo);

                        localStorage.setItem('userInfo', JSON.stringify({
                            name: userInfo.name,
                            email: userInfo.email,
                            preferredLanguage: userInfo.preferredLanguage
                        }));
                        localStorage.setItem('isLoggedIn', 'true');

                        // ì‚¬ìš©ìì˜ ì„ í˜¸ ì–¸ì–´ ì„¤ì •
                        if (userInfo.preferredLanguage) {
                            const langMap = {
                                'KOREAN': 'í•œêµ­ì–´',
                                'ENGLISH': 'English',
                                'CHINESE': 'ä¸­æ–‡',
                                'VIETNAMESE': 'Tiáº¿ng Viá»‡t',
                                'JAPANESE': 'æ—¥æœ¬èª'
                            };
                            const langName = langMap[userInfo.preferredLanguage] || 'í•œêµ­ì–´';
                            localStorage.setItem('language', langName);
                        }

                        // í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™
                        console.log('ğŸ  í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™:', '/home');
                        window.location.href = '/home';
                    } else {
                        console.error('âŒ /me í˜¸ì¶œ ì‹¤íŒ¨:', meResponse.status);
                        const meError = await meResponse.text();
                        console.error('ì—ëŸ¬ ë‚´ìš©:', meError);
                        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    } else {
                        console.error('âŒ JWT í† í°ì´ ì‘ë‹µì— ì—†ìŒ:', loginResult);
                        alert('ë¡œê·¸ì¸ ì‘ë‹µì— í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } else {
                    console.error('âŒ ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨:', loginResponse.status);
                    // íšŒì›ê°€ì…ì€ ì„±ê³µí–ˆì§€ë§Œ ë¡œê·¸ì¸ ì‹¤íŒ¨
                    alert(getErrorMessage('signup.success.login_required'));
                    window.location.href = '/auth/login';
                }
            } catch (error) {
                console.error('âŒ Signup error:', error);
                const errorMsg = getErrorMessage('signup.error.network');
                alert(errorMsg);
            }
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ ë‹¤êµ­ì–´ ì²˜ë¦¬
        function getErrorMessage(key) {
            const messages = {
                'signup.error.password_mismatch': {
                    'ko': 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                    'en': 'Passwords do not match.',
                    'vi': 'Máº­t kháº©u khÃ´ng khá»›p.',
                    'zh': 'å¯†ç ä¸åŒ¹é…ã€‚',
                    'ja': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚'
                },
                'signup.error.password_length': {
                    'ko': 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.',
                    'en': 'Password must be at least 8 characters.',
                    'vi': 'Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 8 kÃ½ tá»±.',
                    'zh': 'å¯†ç å¿…é¡»è‡³å°‘8ä¸ªå­—ç¬¦ã€‚',
                    'ja': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚'
                },
                'signup.error.duplicate': {
                    'ko': 'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
                    'en': 'Email already registered.',
                    'vi': 'Email Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½.',
                    'zh': 'ç”µå­é‚®ä»¶å·²æ³¨å†Œã€‚',
                    'ja': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚'
                },
                'signup.error.failed': {
                    'ko': 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                    'en': 'Signup failed.',
                    'vi': 'ÄÄƒng kÃ½ tháº¥t báº¡i.',
                    'zh': 'æ³¨å†Œå¤±è´¥ã€‚',
                    'ja': 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'
                },
                'signup.error.network': {
                    'ko': 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                    'en': 'Signup failed. Please try again.',
                    'vi': 'ÄÄƒng kÃ½ tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.',
                    'zh': 'æ³¨å†Œå¤±è´¥ã€‚è¯·é‡è¯•ã€‚',
                    'ja': 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                },
                'signup.success.login_required': {
                    'ko': 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',
                    'en': 'Signup completed. Please login.',
                    'vi': 'ÄÄƒng kÃ½ hoÃ n táº¥t. Vui lÃ²ng Ä‘Äƒng nháº­p.',
                    'zh': 'æ³¨å†Œå®Œæˆã€‚è¯·ç™»å½•ã€‚',
                    'ja': 'ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚'
                }
            };

            const lang = window.i18n ? window.i18n.getLanguageCode(window.i18n.getCurrentLanguage()) : 'ko';
            return messages[key]?.[lang] || messages[key]?.['ko'] || key;
        }
    </script>
</body>
</html>

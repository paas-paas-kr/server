<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 상담 - 다문화 가정 상담 서비스</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- 상단 네비게이션 -->
    <nav class="top-nav">
        <div class="top-nav-content">
            <div class="top-nav-logo">
                <span class="top-nav-logo-icon">🌏</span>
                <span data-i18n="nav.logo">다문화 가정 지원</span>
            </div>
            <div class="top-nav-menu">
                <a href="/home" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span data-i18n="nav.home">홈</span>
                </a>
                <a href="/chat" class="top-nav-item active">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span data-i18n="nav.chat">채팅</span>
                </a>
                <a href="/document" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span data-i18n="nav.document">문서</span>
                </a>
                <a href="/mypage" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span data-i18n="nav.mypage">마이페이지</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="chat-layout with-top-nav">
        <!-- 왼쪽 사이드바: 채팅 스레드 목록 -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="createNewThread()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span data-i18n="chat.newChat">새로운 대화</span>
                </button>
            </div>

            <div class="chat-threads" id="chatThreads">
                <!-- 채팅 스레드 목록이 여기에 동적으로 추가됩니다 -->
            </div>

            <div class="sidebar-footer">
                <a href="/document" class="user-profile" style="text-decoration: none; margin-bottom: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span style="font-size: 14px;" data-i18n="chat.documentSummary">문서 요약</span>
                </a>
                <a href="/mypage" class="user-profile">
                    <div class="user-avatar" id="sidebarAvatar">사</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarUserName" data-i18n="chat.user">사용자</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- 오른쪽 메인 채팅 영역 -->
        <div class="chat-main">
            <!-- 다문화 가정 안내 -->
            <div class="welcome-box" id="welcomeBox">
                <h3 style="color: #92400e; font-size: 24px; font-weight: 700; margin-bottom: 16px;" data-i18n="chat.welcomeTitle">🌏 다문화 가정을 위한 AI 상담 서비스</h3>
                <p style="color: #78350f; font-size: 16px; line-height: 1.6; margin-bottom: 24px;" data-i18n="chat.welcomeDesc">
                    안녕하세요! 언어와 문화의 장벽 없이 필요한 도움을 받으실 수 있도록 돕는 AI 상담사입니다.
                    편안하게 궁금하신 것을 물어보세요.
                </p>
                <div class="feature-list">
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">💬</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature1.title">24시간 상담</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature1.desc">언제든지 대화를 시작하세요</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">📄</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature2.title">문서 도움</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature2.desc">복잡한 서류를 쉽게 이해하세요</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">🌐</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature3.title">다국어 지원</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature3.desc">모국어로 편하게 소통하세요</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">🔒</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature4.title">안전한 상담</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature4.desc">개인정보가 보호됩니다</div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- 빈 상태 -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <h3 class="empty-title" data-i18n="chat.empty.title">대화를 시작해보세요</h3>
                    <p class="empty-text" data-i18n="chat.empty.text">궁금한 것을 물어보세요</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <form class="chat-input-form" onsubmit="sendMessage(event)">
                        <textarea
                            class="chat-input"
                            id="messageInput"
                            data-i18n-placeholder="chat.placeholder"
                            placeholder="메시지를 입력하세요..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button type="submit" class="send-btn" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentThread = null;

        // 사용자 정보 로드
        function loadUserInfo() {
            const defaultName = window.i18n ? window.i18n.translate('chat.user') : '사용자';
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || JSON.stringify({name: defaultName, email: "user@example.com"}));
            document.getElementById('sidebarUserName').textContent = userInfo.name || defaultName;
            document.getElementById('sidebarAvatar').textContent = (userInfo.name || defaultName).charAt(0);
        }

        // 로컬 스토리지에서 채팅 스레드 목록 가져오기
        function getChatThreads() {
            const threads = localStorage.getItem('chatThreads');
            return threads ? JSON.parse(threads) : [];
        }

        // 채팅 스레드 목록 저장
        function saveChatThreads(threads) {
            localStorage.setItem('chatThreads', JSON.stringify(threads));
        }

        // 채팅 목록 렌더링
        function renderThreadList() {
            console.log('Rendering thread list');
            const threads = getChatThreads();
            const chatThreads = document.getElementById('chatThreads');

            if (!chatThreads) {
                console.error('chatThreads element not found');
                return;
            }

            if (threads.length === 0) {
                const noThreadsText = window.i18n ? window.i18n.translate('chat.noThreads') : '아직 대화가 없습니다';
                chatThreads.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 14px;">
                        ${noThreadsText}
                    </div>
                `;
                return;
            }

            const newConvText = window.i18n ? window.i18n.translate('chat.newConversation') : '새 대화';
            chatThreads.innerHTML = threads.map(thread => {
                const titleText = thread.title || newConvText;
                const previewText = thread.lastMessage || newConvText;
                const isActive = currentThread && currentThread.id === thread.id;

                return `
                    <a href="#" class="thread-item ${isActive ? 'active' : ''}" onclick="selectThread('${thread.id}'); return false;">
                        <div class="thread-item-title">${titleText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        <div class="thread-item-preview">${previewText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                    </a>
                `;
            }).join('');
            console.log('Thread list rendered, total threads:', threads.length, 'active thread:', currentThread?.id);
        }

        // 스레드 선택
        function selectThread(threadId) {
            console.log('Selecting thread:', threadId);
            const threads = getChatThreads();
            currentThread = threads.find(t => t.id === threadId);

            if (currentThread) {
                console.log('Thread found:', currentThread);
                // 스레드 선택 시 웰컴 박스 숨기기
                const welcomeBox = document.getElementById('welcomeBox');
                if (welcomeBox) welcomeBox.style.display = 'none';

                renderThreadList(); // active 상태 업데이트
                renderMessages(); // 메시지 렌더링
            } else {
                console.error('Thread not found:', threadId);
            }
        }

        // 메시지 렌더링
        function renderMessages() {
            console.log('Rendering messages');
            const messagesContainer = document.getElementById('chatMessages');
            const emptyState = document.getElementById('emptyState');
            const welcomeBox = document.getElementById('welcomeBox');

            if (!messagesContainer) {
                console.error('messagesContainer not found');
                return;
            }

            if (!currentThread || !currentThread.messages || currentThread.messages.length === 0) {
                console.log('No messages to display');
                if (emptyState) emptyState.style.display = 'none';
                if (welcomeBox) welcomeBox.style.display = 'block';
                messagesContainer.innerHTML = '';
                return;
            }

            console.log('Displaying', currentThread.messages.length, 'messages');
            if (emptyState) emptyState.style.display = 'none';
            if (welcomeBox) welcomeBox.style.display = 'none';

            // 기존 메시지 유지하면서 새 메시지 추가
            const userText = window.i18n ? window.i18n.translate('chat.user') : '나';
            messagesContainer.innerHTML = currentThread.messages.map(msg => `
                <div class="message ${msg.role}">
                    <div class="message-avatar">${msg.role === 'ai' ? 'AI' : userText}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                </div>
            `).join('');

            // 스크롤을 맨 아래로
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
        }

        // 새 스레드 생성
        function createNewThread() {
            console.log('Creating new thread');
            const threads = getChatThreads();
            const newChatText = window.i18n ? window.i18n.translate('chat.newChat') : '새로운 대화';
            const newThread = {
                id: Date.now().toString(),
                title: newChatText,
                lastMessage: '',
                messageCount: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                messages: []
            };

            threads.unshift(newThread);
            saveChatThreads(threads);
            currentThread = newThread;

            // 새 대화 시작 시 웰컴 박스 표시
            const welcomeBox = document.getElementById('welcomeBox');
            if (welcomeBox) welcomeBox.style.display = 'block';

            renderThreadList();
            renderMessages();

            // 입력창에 포커스
            document.getElementById('messageInput').focus();
            console.log('New thread created:', newThread);
        }

        // 메시지 전송
        async function sendMessage(event) {
            event.preventDefault();
            console.log('Send message triggered');

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            console.log('Message:', message);
            if (!message) {
                console.log('Empty message, returning');
                return;
            }

            // 현재 스레드가 없으면 새로 생성
            if (!currentThread) {
                console.log('No current thread, creating new one');
                createNewThread();
            }

            console.log('Current thread:', currentThread);

            // 사용자 메시지 추가
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // 로딩 표시
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner"></div>';

            // AI 응답 시뮬레이션 (실제로는 API 호출)
            try {
                await simulateAIResponse(message);
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('ai', '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                `;
            }
        }

        // AI 응답 시뮬레이션
        async function simulateAIResponse(userMessage) {
            await new Promise(resolve => setTimeout(resolve, 1000));

            let aiResponse = '';

            if (userMessage.includes('안녕') || userMessage.includes('하이') || userMessage.includes('hi')) {
                aiResponse = '안녕하세요! 다문화 가정 상담 AI입니다. 무엇을 도와드릴까요?';
            } else if (userMessage.includes('도와') || userMessage.includes('도움')) {
                aiResponse = '네, 기꺼이 도와드리겠습니다. 구체적으로 어떤 부분이 궁금하신가요?';
            } else if (userMessage.includes('문서') || userMessage.includes('서류')) {
                aiResponse = '문서 관련 도움이 필요하시군요. 왼쪽 하단의 "문서 요약" 메뉴에서 파일을 업로드하시면 내용을 요약해드릴 수 있습니다.';
            } else {
                aiResponse = `"${userMessage}"에 대해 말씀하셨군요. 더 자세히 설명해주시면 더 나은 답변을 드릴 수 있습니다.`;
            }

            addMessage('ai', aiResponse);
        }

        // 메시지 추가
        function addMessage(role, content) {
            console.log('Adding message:', role, content);
            if (!currentThread) {
                console.error('No current thread');
                return;
            }

            if (!currentThread.messages) {
                currentThread.messages = [];
            }

            const message = {
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            };

            currentThread.messages.push(message);
            currentThread.lastMessage = content.substring(0, 50);
            currentThread.messageCount = currentThread.messages.length;
            currentThread.updatedAt = new Date().toISOString();

            // 제목 자동 생성 (첫 메시지일 경우)
            if (currentThread.messages.length === 1 && role === 'user') {
                currentThread.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
            }

            saveThread();
            renderMessages();
            renderThreadList();
            console.log('Message added successfully');
        }

        // 스레드 저장
        function saveThread() {
            const threads = getChatThreads();
            const index = threads.findIndex(t => t.id === currentThread.id);

            if (index >= 0) {
                threads[index] = currentThread;
            } else {
                threads.unshift(currentThread);
            }

            saveChatThreads(threads);
        }

        // 키 이벤트 처리
        function handleKeyDown(event) {
            // 텍스트 영역 자동 높이 조절
            setTimeout(() => {
                const textarea = event.target;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            }, 0);

            // 한국어/일본어/중국어 등 IME 입력 중일 때는 Enter 키 무시
            if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) {
                event.preventDefault();
                const form = document.querySelector('.chat-input-form');
                if (form) {
                    // Form submit 이벤트 트리거
                    form.requestSubmit();
                }
            }
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 로그인 체크
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                window.location.href = '/auth/login';
                return;
            }

            // 언어 적용
            if (window.i18n) {
                window.i18n.updatePageLanguage();
            }

            // 사용자 정보 로드
            loadUserInfo();

            // 채팅 목록 렌더링
            renderThreadList();

            // 첫 번째 스레드가 있으면 선택
            const threads = getChatThreads();
            if (threads.length > 0) {
                selectThread(threads[0].id);
            } else {
                // 스레드가 없으면 빈 상태 표시
                const emptyState = document.getElementById('emptyState');
                const welcomeBox = document.getElementById('welcomeBox');
                if (emptyState) emptyState.style.display = 'block';
                if (welcomeBox) welcomeBox.style.display = 'block';
            }
        });
    </script>

    <script src="/js/i18n.js"></script>
</body>
</html>

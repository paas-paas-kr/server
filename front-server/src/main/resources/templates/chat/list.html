<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 상담 - 다문화 가정 상담 서비스</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- 상단 네비게이션 -->
    <nav class="top-nav">
        <div class="top-nav-content">
            <div class="top-nav-logo">
                <span class="top-nav-logo-icon">🌏</span>
                <span data-i18n="nav.logo">다문화 가정 지원</span>
            </div>
            <div class="top-nav-menu">
                <a href="/home" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span data-i18n="nav.home">홈</span>
                </a>
                <a href="/chat" class="top-nav-item active">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span data-i18n="nav.chat">채팅</span>
                </a>
                <a href="/document" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span data-i18n="nav.document">문서</span>
                </a>
                <a href="/mypage" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span data-i18n="nav.mypage">마이페이지</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="chat-layout with-top-nav">
        <!-- 왼쪽 사이드바: 채팅 스레드 목록 -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="createNewThread()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span data-i18n="chat.newChat">새로운 대화</span>
                </button>
            </div>

            <div class="chat-threads" id="chatThreads">
                <!-- 채팅 스레드 목록이 여기에 동적으로 추가됩니다 -->
            </div>

            <div class="sidebar-footer">
                <a href="/document" class="user-profile" style="text-decoration: none; margin-bottom: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span style="font-size: 14px;" data-i18n="chat.documentSummary">문서 요약</span>
                </a>
                <a href="/mypage" class="user-profile">
                    <div class="user-avatar" id="sidebarAvatar">사</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarUserName" data-i18n="chat.user">사용자</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- 오른쪽 메인 채팅 영역 -->
        <div class="chat-main">
            <!-- 다문화 가정 안내 -->
            <div class="welcome-box" id="welcomeBox">
                <h3 style="color: #92400e; font-size: 24px; font-weight: 700; margin-bottom: 16px;" data-i18n="chat.welcomeTitle">🌏 다문화 가정을 위한 AI 상담 서비스</h3>
                <p style="color: #78350f; font-size: 16px; line-height: 1.6; margin-bottom: 24px;" data-i18n="chat.welcomeDesc">
                    안녕하세요! 언어와 문화의 장벽 없이 필요한 도움을 받으실 수 있도록 돕는 AI 상담사입니다.
                    편안하게 궁금하신 것을 물어보세요.
                </p>
                <div class="feature-list">
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">💬</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature1.title">24시간 상담</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature1.desc">언제든지 대화를 시작하세요</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">📄</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature2.title">문서 도움</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature2.desc">복잡한 서류를 쉽게 이해하세요</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">🌐</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature3.title">다국어 지원</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature3.desc">모국어로 편하게 소통하세요</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">🔒</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature4.title">안전한 상담</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature4.desc">개인정보가 보호됩니다</div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- 빈 상태 -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <h3 class="empty-title" data-i18n="chat.empty.title">대화를 시작해보세요</h3>
                    <p class="empty-text" data-i18n="chat.empty.text">궁금한 것을 물어보세요</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <form class="chat-input-form" onsubmit="sendMessage(event)">
                        <textarea
                            class="chat-input"
                            id="messageInput"
                            data-i18n-placeholder="chat.placeholder"
                            placeholder="메시지를 입력하세요..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button type="submit" class="send-btn" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/i18n.js"></script>
    <script>
        let currentThread = null;
        let chatRooms = [];
        let pageToken = null;
        let hasMore = true;

        // 사용자 정보 로드
        function loadUserInfo() {
            const defaultName = window.i18n ? window.i18n.translate('chat.user') : '사용자';
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || JSON.stringify({name: defaultName, email: "user@example.com"}));
            document.getElementById('sidebarUserName').textContent = userInfo.name || defaultName;
            document.getElementById('sidebarAvatar').textContent = (userInfo.name || defaultName).charAt(0);
        }

        // 서버에서 채팅방 목록 가져오기
        async function getChatThreads() {
            try {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('No access token found');
                    return [];
                }

                const url = `${window.API_BASE_URL}/api/chat/conversations/rooms?size=20`;
                console.log('Fetching chat rooms from:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Failed to fetch chat rooms:', response.status);
                    return [];
                }

                const data = await response.json();
                console.log('Chat rooms received:', data);

                chatRooms = data.items || [];
                pageToken = data.nextPageToken;
                hasMore = data.hasMore || false;

                // 서버 데이터 형식을 프론트 형식으로 변환
                return chatRooms.map(room => ({
                    id: room.roomId,
                    title: room.title || '새 대화',
                    lastMessage: room.lastMessage || '',
                    messageCount: room.messageCount || 0,
                    createdAt: room.createdAt,
                    updatedAt: room.updatedAt,
                    messages: [] // 메시지는 별도 조회
                }));
            } catch (error) {
                console.error('Error fetching chat rooms:', error);
                return [];
            }
        }

        // 채팅 목록 렌더링
        async function renderThreadList() {
            console.log('Rendering thread list');
            const threads = await getChatThreads();
            const chatThreads = document.getElementById('chatThreads');

            if (!chatThreads) {
                console.error('chatThreads element not found');
                return;
            }

            if (threads.length === 0) {
                const noThreadsText = window.i18n ? window.i18n.translate('chat.noThreads') : '아직 대화가 없습니다';
                chatThreads.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 14px;">
                        ${noThreadsText}
                    </div>
                `;
                return;
            }

            const newConvText = window.i18n ? window.i18n.translate('chat.newConversation') : '새 대화';
            chatThreads.innerHTML = threads.map(thread => {
                const titleText = thread.title || newConvText;
                const previewText = thread.lastMessage || newConvText;
                const isActive = currentThread && currentThread.id === thread.id;

                return `
                    <a href="#" class="thread-item ${isActive ? 'active' : ''}" onclick="selectThread('${thread.id}'); return false;">
                        <div class="thread-item-title">${titleText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        <div class="thread-item-preview">${previewText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                    </a>
                `;
            }).join('');
            console.log('Thread list rendered, total threads:', threads.length, 'active thread:', currentThread?.id);
        }

        // 서버에서 채팅 메시지 가져오기
        async function getChatMessages(roomId) {
            try {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('No access token found');
                    return [];
                }

                const url = `${window.API_BASE_URL}/api/chat/conversations/room/${roomId}/messages?size=50`;
                console.log('Fetching messages from:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Failed to fetch messages:', response.status);
                    return [];
                }

                const data = await response.json();
                console.log('Messages received:', data);

                const messages = data.items || [];

                // 서버 데이터를 프론트 형식으로 변환 (역순 정렬)
                return messages.reverse().map(msg => ({
                    role: msg.isUserMessage ? 'user' : 'ai',
                    content: msg.content || msg.text,
                    timestamp: msg.createdAt
                }));
            } catch (error) {
                console.error('Error fetching messages:', error);
                return [];
            }
        }

        // 스레드 선택
        async function selectThread(threadId) {
            console.log('Selecting thread:', threadId);
            const threads = await getChatThreads();
            currentThread = threads.find(t => t.id === threadId);

            if (currentThread) {
                console.log('Thread found:', currentThread);

                // 서버에서 메시지 가져오기
                currentThread.messages = await getChatMessages(threadId);

                // 스레드 선택 시 웰컴 박스 숨기기
                const welcomeBox = document.getElementById('welcomeBox');
                if (welcomeBox) welcomeBox.style.display = 'none';

                await renderThreadList(); // active 상태 업데이트
                renderMessages(); // 메시지 렌더링
            } else {
                console.error('Thread not found:', threadId);
            }
        }

        // 메시지 렌더링
        function renderMessages() {
            console.log('Rendering messages');
            const messagesContainer = document.getElementById('chatMessages');
            const emptyState = document.getElementById('emptyState');
            const welcomeBox = document.getElementById('welcomeBox');

            if (!messagesContainer) {
                console.error('messagesContainer not found');
                return;
            }

            if (!currentThread || !currentThread.messages || currentThread.messages.length === 0) {
                console.log('No messages to display');
                if (emptyState) emptyState.style.display = 'none';
                if (welcomeBox) welcomeBox.style.display = 'block';
                messagesContainer.innerHTML = '';
                return;
            }

            console.log('Displaying', currentThread.messages.length, 'messages');
            if (emptyState) emptyState.style.display = 'none';
            if (welcomeBox) welcomeBox.style.display = 'none';

            // 기존 메시지 유지하면서 새 메시지 추가
            const userText = window.i18n ? window.i18n.translate('chat.user') : '나';
            messagesContainer.innerHTML = currentThread.messages.map(msg => `
                <div class="message ${msg.role}">
                    <div class="message-avatar">${msg.role === 'ai' ? 'AI' : userText}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                </div>
            `).join('');

            // 스크롤을 맨 아래로
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
        }

        // 새 스레드 생성 (서버 API 호출)
        async function createNewThread() {
            console.log('Creating new thread');

            try {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('No access token found');
                    alert('로그인이 필요합니다.');
                    return;
                }

                const url = `${window.API_BASE_URL}/api/chat/conversations`;
                console.log('Creating new chat room:', url);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Failed to create chat room:', response.status);
                    alert('채팅방 생성에 실패했습니다.');
                    return;
                }

                const newRoom = await response.json();
                console.log('New room created:', newRoom);

                const newChatText = window.i18n ? window.i18n.translate('chat.newChat') : '새로운 대화';
                currentThread = {
                    id: newRoom.roomId,
                    title: newRoom.title || newChatText,
                    lastMessage: '',
                    messageCount: 0,
                    createdAt: newRoom.createdAt,
                    updatedAt: newRoom.updatedAt,
                    messages: []
                };

                // 새 대화 시작 시 웰컴 박스 표시
                const welcomeBox = document.getElementById('welcomeBox');
                if (welcomeBox) welcomeBox.style.display = 'block';

                await renderThreadList();
                renderMessages();

                // 입력창에 포커스
                document.getElementById('messageInput').focus();
                console.log('New thread created:', currentThread);
            } catch (error) {
                console.error('Error creating new thread:', error);
                alert('채팅방 생성 중 오류가 발생했습니다.');
            }
        }

        // WebSocket 연결
        let ws = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        function connectWebSocket() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                console.error('No access token found');
                return;
            }

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // 프로덕션: 현재 도메인 사용, 로컬: API_BASE_URL 사용
            let wsHost;
            if (window.API_BASE_URL && window.API_BASE_URL !== '') {
                wsHost = new URL(window.API_BASE_URL).host;
            } else {
                wsHost = window.location.host;
            }
            const wsUrl = `${wsProtocol}//${wsHost}/ws/chat?token=${token}`;

            console.log('Connecting to WebSocket:', wsUrl);

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                };

                ws.onmessage = function(event) {
                    console.log('WebSocket message received:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };

                ws.onclose = function(event) {
                    console.log('WebSocket closed:', event.code, event.reason);

                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        console.log(`Reconnecting... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                        setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                    }
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
            }
        }

        function sendWebSocketMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                console.log('Message sent:', message);
            } else {
                console.error('WebSocket is not connected');
            }
        }

        let lastAIMessageContent = '';
        function handleWebSocketMessage(data) {
            console.log('Handling message:', data);

            if (data.type === 'nlp-stream') {
                if (data.event === 'original_text') {
                    const aiText = data.data?.text || '';
                    if (aiText) {
                        updateOrAddAIMessage(aiText);
                    }
                } else if (data.event === 'delta') {
                    const delta = data.data?.delta || '';
                    if (delta) {
                        appendToLastAIMessage(delta);
                    }
                }
            } else if (data.type === 'CHAT' || data.type === 'TRANS') {
                const text = data.text || data.data?.text || '';
                if (text) {
                    updateOrAddAIMessage(text);
                }
            } else if (data.type === 'ERROR') {
                const errorText = data.text || '오류가 발생했습니다.';
                addMessage('ai', errorText);
            }
        }

        function updateOrAddAIMessage(text) {
            if (lastAIMessageContent === text) return;
            lastAIMessageContent = text;

            if (currentThread.messages.length > 0) {
                const lastMessage = currentThread.messages[currentThread.messages.length - 1];
                if (lastMessage.role === 'ai' && !lastMessage.finalized) {
                    lastMessage.content = text;
                    lastMessage.finalized = true;
                } else {
                    addMessage('ai', text);
                }
            } else {
                addMessage('ai', text);
            }
            renderMessages();
        }

        function appendToLastAIMessage(delta) {
            if (currentThread.messages.length > 0) {
                const lastMessage = currentThread.messages[currentThread.messages.length - 1];
                if (lastMessage.role === 'ai' && !lastMessage.finalized) {
                    lastMessage.content += delta;
                    renderMessages();
                    return;
                }
            }

            const newMessage = {
                role: 'ai',
                content: delta,
                timestamp: new Date().toISOString(),
                finalized: false
            };
            currentThread.messages.push(newMessage);
            renderMessages();
        }

        // 메시지 전송
        async function sendMessage(event) {
            event.preventDefault();
            console.log('Send message triggered');

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            console.log('Message:', message);
            if (!message) {
                console.log('Empty message, returning');
                return;
            }

            // 현재 스레드가 없으면 새로 생성
            if (!currentThread) {
                console.log('No current thread, creating new one');
                await createNewThread();
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('서버와 연결되어 있지 않습니다. 페이지를 새로고침해주세요.');
                return;
            }

            console.log('Current thread:', currentThread);

            // 사용자 메시지 추가
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // 로딩 표시
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner"></div>';

            try {
                sendWebSocketMessage({
                    type: 'CHAT',
                    text: message,
                    userId: 'user',
                    lang: window.i18n ? window.i18n.getLanguageCode(window.i18n.getCurrentLanguage()) : 'KOREAN',
                    roomId: currentThread.id
                });

                lastAIMessageContent = '';
                const tempMessage = {
                    role: 'ai',
                    content: '...',
                    timestamp: new Date().toISOString(),
                    finalized: false
                };
                currentThread.messages.push(tempMessage);
                renderMessages();
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('ai', '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                `;
            }
        }

        // 메시지 추가
        function addMessage(role, content) {
            console.log('Adding message:', role, content);
            if (!currentThread) {
                console.error('No current thread');
                return;
            }

            if (!currentThread.messages) {
                currentThread.messages = [];
            }

            const message = {
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            };

            currentThread.messages.push(message);
            currentThread.lastMessage = content.substring(0, 50);
            currentThread.messageCount = currentThread.messages.length;
            currentThread.updatedAt = new Date().toISOString();

            // 제목 자동 생성 (첫 메시지일 경우)
            if (currentThread.messages.length === 1 && role === 'user') {
                currentThread.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
            }

            renderMessages();
            console.log('Message added successfully');
        }

        // 키 이벤트 처리
        function handleKeyDown(event) {
            // 텍스트 영역 자동 높이 조절
            setTimeout(() => {
                const textarea = event.target;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            }, 0);

            // 한국어/일본어/중국어 등 IME 입력 중일 때는 Enter 키 무시
            if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) {
                event.preventDefault();
                const form = document.querySelector('.chat-input-form');
                if (form) {
                    // Form submit 이벤트 트리거
                    form.requestSubmit();
                }
            }
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            // 로그인 체크
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                window.location.href = '/auth/login';
                return;
            }

            // 언어 적용
            if (window.i18n) {
                window.i18n.updatePageLanguage();
            }

            // 사용자 정보 로드
            loadUserInfo();

            // WebSocket 연결
            connectWebSocket();

            // 채팅 목록 렌더링
            await renderThreadList();

            // 첫 번째 스레드가 있으면 선택
            const threads = await getChatThreads();
            if (threads.length > 0) {
                await selectThread(threads[0].id);
            } else {
                // 스레드가 없으면 빈 상태 표시
                const emptyState = document.getElementById('emptyState');
                const welcomeBox = document.getElementById('welcomeBox');
                if (emptyState) emptyState.style.display = 'block';
                if (welcomeBox) welcomeBox.style.display = 'block';
            }
        });

        // 페이지 종료 시 WebSocket 연결 해제
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>

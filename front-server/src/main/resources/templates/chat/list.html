<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìƒë‹´ - ë‹¤ë¬¸í™” ê°€ì • ìƒë‹´ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="top-nav">
        <div class="top-nav-content">
            <div class="top-nav-logo">
                <span class="top-nav-logo-icon">ğŸŒ</span>
                <span data-i18n="nav.logo">ë‹¤ë¬¸í™” ê°€ì • ì§€ì›</span>
            </div>
            <div class="top-nav-menu">
                <a href="/home" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span data-i18n="nav.home">í™ˆ</span>
                </a>
                <a href="/chat" class="top-nav-item active">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span data-i18n="nav.chat">ì±„íŒ…</span>
                </a>
                <a href="/document" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span data-i18n="nav.document">ë¬¸ì„œ</span>
                </a>
                <a href="/mypage" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span data-i18n="nav.mypage">ë§ˆì´í˜ì´ì§€</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="chat-layout with-top-nav">
        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°”: ì±„íŒ… ìŠ¤ë ˆë“œ ëª©ë¡ -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="createNewThread()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span data-i18n="chat.newChat">ìƒˆë¡œìš´ ëŒ€í™”</span>
                </button>
            </div>

            <div class="chat-threads" id="chatThreads">
                <!-- ì±„íŒ… ìŠ¤ë ˆë“œ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <div class="sidebar-footer">
                <a href="/document" class="user-profile" style="text-decoration: none; margin-bottom: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span style="font-size: 14px;" data-i18n="chat.documentSummary">ë¬¸ì„œ ìš”ì•½</span>
                </a>
                <a href="/mypage" class="user-profile">
                    <div class="user-avatar" id="sidebarAvatar">ì‚¬</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarUserName" data-i18n="chat.user">ì‚¬ìš©ì</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <div class="chat-main">
            <!-- ë‹¤ë¬¸í™” ê°€ì • ì•ˆë‚´ -->
            <div class="welcome-box" id="welcomeBox">
                <h3 style="color: #92400e; font-size: 24px; font-weight: 700; margin-bottom: 16px;" data-i18n="chat.welcomeTitle">ğŸŒ ë‹¤ë¬¸í™” ê°€ì •ì„ ìœ„í•œ AI ìƒë‹´ ì„œë¹„ìŠ¤</h3>
                <p style="color: #78350f; font-size: 16px; line-height: 1.6; margin-bottom: 24px;" data-i18n="chat.welcomeDesc">
                    ì•ˆë…•í•˜ì„¸ìš”! ì–¸ì–´ì™€ ë¬¸í™”ì˜ ì¥ë²½ ì—†ì´ í•„ìš”í•œ ë„ì›€ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆë„ë¡ ë•ëŠ” AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.
                    í¸ì•ˆí•˜ê²Œ ê¶ê¸ˆí•˜ì‹  ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”.
                </p>
                <div class="feature-list">
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸ’¬</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature1.title">24ì‹œê°„ ìƒë‹´</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature1.desc">ì–¸ì œë“ ì§€ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“„</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature2.title">ë¬¸ì„œ ë„ì›€</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature2.desc">ë³µì¡í•œ ì„œë¥˜ë¥¼ ì‰½ê²Œ ì´í•´í•˜ì„¸ìš”</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸŒ</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature3.title">ë‹¤êµ­ì–´ ì§€ì›</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature3.desc">ëª¨êµ­ì–´ë¡œ í¸í•˜ê²Œ ì†Œí†µí•˜ì„¸ìš”</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸ”’</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature4.title">ì•ˆì „í•œ ìƒë‹´</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature4.desc">ê°œì¸ì •ë³´ê°€ ë³´í˜¸ë©ë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- ë¹ˆ ìƒíƒœ -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <h3 class="empty-title" data-i18n="chat.empty.title">ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</h3>
                    <p class="empty-text" data-i18n="chat.empty.text">ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <form class="chat-input-form" onsubmit="sendMessage(event)">
                        <textarea
                            class="chat-input"
                            id="messageInput"
                            data-i18n-placeholder="chat.placeholder"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button type="submit" class="send-btn" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/i18n.js"></script>
    <script>
        let currentThread = null;
        let chatRooms = [];
        let pageToken = null;
        let hasMore = true;

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        function loadUserInfo() {
            const defaultName = window.i18n ? window.i18n.translate('chat.user') : 'ì‚¬ìš©ì';
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || JSON.stringify({name: defaultName, email: "user@example.com"}));
            document.getElementById('sidebarUserName').textContent = userInfo.name || defaultName;
            document.getElementById('sidebarAvatar').textContent = (userInfo.name || defaultName).charAt(0);
        }

        // ì„œë²„ì—ì„œ ì±„íŒ…ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function getChatThreads() {
            try {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('No access token found');
                    return [];
                }

                const url = `${window.API_BASE_URL}/api/chat/conversations/rooms?size=20`;
                console.log('Fetching chat rooms from:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Failed to fetch chat rooms:', response.status);
                    return [];
                }

                const data = await response.json();
                console.log('Chat rooms received:', data);

                chatRooms = data.items || [];
                pageToken = data.nextPageToken;
                hasMore = data.hasMore || false;

                // ì„œë²„ ë°ì´í„° í˜•ì‹ì„ í”„ë¡ íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                return chatRooms.map(room => ({
                    id: room.roomId,
                    title: room.title || 'ìƒˆ ëŒ€í™”',
                    lastMessage: room.lastMessage || '',
                    messageCount: room.messageCount || 0,
                    createdAt: room.createdAt,
                    updatedAt: room.updatedAt,
                    messages: [] // ë©”ì‹œì§€ëŠ” ë³„ë„ ì¡°íšŒ
                }));
            } catch (error) {
                console.error('Error fetching chat rooms:', error);
                return [];
            }
        }

        // ì±„íŒ… ëª©ë¡ ë Œë”ë§
        async function renderThreadList() {
            console.log('Rendering thread list');
            const threads = await getChatThreads();
            const chatThreads = document.getElementById('chatThreads');

            if (!chatThreads) {
                console.error('chatThreads element not found');
                return;
            }

            if (threads.length === 0) {
                const noThreadsText = window.i18n ? window.i18n.translate('chat.noThreads') : 'ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤';
                chatThreads.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 14px;">
                        ${noThreadsText}
                    </div>
                `;
                return;
            }

            const newConvText = window.i18n ? window.i18n.translate('chat.newConversation') : 'ìƒˆ ëŒ€í™”';
            chatThreads.innerHTML = threads.map(thread => {
                const titleText = thread.title || newConvText;
                const previewText = thread.lastMessage || newConvText;
                const isActive = currentThread && currentThread.id === thread.id;

                return `
                    <a href="#" class="thread-item ${isActive ? 'active' : ''}" onclick="selectThread('${thread.id}'); return false;">
                        <div class="thread-item-title">${titleText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        <div class="thread-item-preview">${previewText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                    </a>
                `;
            }).join('');
            console.log('Thread list rendered, total threads:', threads.length, 'active thread:', currentThread?.id);
        }

        // ì„œë²„ì—ì„œ ì±„íŒ… ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
        async function getChatMessages(roomId) {
            try {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('No access token found');
                    return [];
                }

                const url = `${window.API_BASE_URL}/api/chat/conversations/room/${roomId}/messages?size=50`;
                console.log('Fetching messages from:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Failed to fetch messages:', response.status);
                    return [];
                }

                const data = await response.json();
                console.log('Messages received:', data);

                const messages = data.items || [];

                // ì„œë²„ ë°ì´í„°ë¥¼ í”„ë¡ íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì—­ìˆœ ì •ë ¬)
                return messages.reverse().map(msg => ({
                    role: msg.isUserMessage ? 'user' : 'ai',
                    content: msg.content || msg.text,
                    timestamp: msg.createdAt
                }));
            } catch (error) {
                console.error('Error fetching messages:', error);
                return [];
            }
        }

        // ìŠ¤ë ˆë“œ ì„ íƒ
        async function selectThread(threadId) {
            console.log('Selecting thread:', threadId);
            const threads = await getChatThreads();
            currentThread = threads.find(t => t.id === threadId);

            if (currentThread) {
                console.log('Thread found:', currentThread);

                // ì„œë²„ì—ì„œ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                currentThread.messages = await getChatMessages(threadId);

                // ìŠ¤ë ˆë“œ ì„ íƒ ì‹œ ì›°ì»´ ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
                const welcomeBox = document.getElementById('welcomeBox');
                if (welcomeBox) welcomeBox.style.display = 'none';

                await renderThreadList(); // active ìƒíƒœ ì—…ë°ì´íŠ¸
                renderMessages(); // ë©”ì‹œì§€ ë Œë”ë§
            } else {
                console.error('Thread not found:', threadId);
            }
        }

        // ë©”ì‹œì§€ ë Œë”ë§
        function renderMessages() {
            console.log('Rendering messages');
            const messagesContainer = document.getElementById('chatMessages');
            const emptyState = document.getElementById('emptyState');
            const welcomeBox = document.getElementById('welcomeBox');

            if (!messagesContainer) {
                console.error('messagesContainer not found');
                return;
            }

            if (!currentThread || !currentThread.messages || currentThread.messages.length === 0) {
                console.log('No messages to display');
                if (emptyState) emptyState.style.display = 'none';
                if (welcomeBox) welcomeBox.style.display = 'block';
                messagesContainer.innerHTML = '';
                return;
            }

            console.log('Displaying', currentThread.messages.length, 'messages');
            if (emptyState) emptyState.style.display = 'none';
            if (welcomeBox) welcomeBox.style.display = 'none';

            // ê¸°ì¡´ ë©”ì‹œì§€ ìœ ì§€í•˜ë©´ì„œ ìƒˆ ë©”ì‹œì§€ ì¶”ê°€
            const userText = window.i18n ? window.i18n.translate('chat.user') : 'ë‚˜';
            messagesContainer.innerHTML = currentThread.messages.map(msg => `
                <div class="message ${msg.role}">
                    <div class="message-avatar">${msg.role === 'ai' ? 'AI' : userText}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                </div>
            `).join('');

            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
        }

        // ìƒˆ ìŠ¤ë ˆë“œ ìƒì„± (ì„œë²„ API í˜¸ì¶œ)
        async function createNewThread() {
            console.log('Creating new thread');

            try {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    console.error('No access token found');
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                const url = `${window.API_BASE_URL}/api/chat/conversations`;
                console.log('Creating new chat room:', url);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Failed to create chat room:', response.status);
                    alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const newRoom = await response.json();
                console.log('New room created:', newRoom);

                const newChatText = window.i18n ? window.i18n.translate('chat.newChat') : 'ìƒˆë¡œìš´ ëŒ€í™”';
                currentThread = {
                    id: newRoom.roomId,
                    title: newRoom.title || newChatText,
                    lastMessage: '',
                    messageCount: 0,
                    createdAt: newRoom.createdAt,
                    updatedAt: newRoom.updatedAt,
                    messages: []
                };

                // ìƒˆ ëŒ€í™” ì‹œì‘ ì‹œ ì›°ì»´ ë°•ìŠ¤ í‘œì‹œ
                const welcomeBox = document.getElementById('welcomeBox');
                if (welcomeBox) welcomeBox.style.display = 'block';

                await renderThreadList();
                renderMessages();

                // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
                document.getElementById('messageInput').focus();
                console.log('New thread created:', currentThread);
            } catch (error) {
                console.error('Error creating new thread:', error);
                alert('ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // WebSocket ì—°ê²°
        let ws = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        function connectWebSocket() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                console.error('No access token found');
                return;
            }

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // í”„ë¡œë•ì…˜: í˜„ì¬ ë„ë©”ì¸ ì‚¬ìš©, ë¡œì»¬: API_BASE_URL ì‚¬ìš©
            let wsHost;
            if (window.API_BASE_URL && window.API_BASE_URL !== '') {
                wsHost = new URL(window.API_BASE_URL).host;
            } else {
                wsHost = window.location.host;
            }
            const wsUrl = `${wsProtocol}//${wsHost}/ws/chat?token=${token}`;

            console.log('Connecting to WebSocket:', wsUrl);

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                };

                ws.onmessage = function(event) {
                    console.log('WebSocket message received:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };

                ws.onclose = function(event) {
                    console.log('WebSocket closed:', event.code, event.reason);

                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        console.log(`Reconnecting... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                        setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                    }
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
            }
        }

        function sendWebSocketMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                console.log('Message sent:', message);
            } else {
                console.error('WebSocket is not connected');
            }
        }

        let lastAIMessageContent = '';
        function handleWebSocketMessage(data) {
            console.log('Handling message:', data);

            if (data.type === 'nlp-stream') {
                if (data.event === 'original_text') {
                    const aiText = data.data?.text || '';
                    if (aiText) {
                        updateOrAddAIMessage(aiText);
                    }
                } else if (data.event === 'delta') {
                    const delta = data.data?.delta || '';
                    if (delta) {
                        appendToLastAIMessage(delta);
                    }
                }
            } else if (data.type === 'CHAT' || data.type === 'TRANS') {
                const text = data.text || data.data?.text || '';
                if (text) {
                    updateOrAddAIMessage(text);
                }
            } else if (data.type === 'ERROR') {
                const errorText = data.text || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                addMessage('ai', errorText);
            }
        }

        function updateOrAddAIMessage(text) {
            if (lastAIMessageContent === text) return;
            lastAIMessageContent = text;

            if (currentThread.messages.length > 0) {
                const lastMessage = currentThread.messages[currentThread.messages.length - 1];
                if (lastMessage.role === 'ai' && !lastMessage.finalized) {
                    lastMessage.content = text;
                    lastMessage.finalized = true;
                } else {
                    addMessage('ai', text);
                }
            } else {
                addMessage('ai', text);
            }
            renderMessages();
        }

        function appendToLastAIMessage(delta) {
            if (currentThread.messages.length > 0) {
                const lastMessage = currentThread.messages[currentThread.messages.length - 1];
                if (lastMessage.role === 'ai' && !lastMessage.finalized) {
                    lastMessage.content += delta;
                    renderMessages();
                    return;
                }
            }

            const newMessage = {
                role: 'ai',
                content: delta,
                timestamp: new Date().toISOString(),
                finalized: false
            };
            currentThread.messages.push(newMessage);
            renderMessages();
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage(event) {
            event.preventDefault();
            console.log('Send message triggered');

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            console.log('Message:', message);
            if (!message) {
                console.log('Empty message, returning');
                return;
            }

            // í˜„ì¬ ìŠ¤ë ˆë“œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (!currentThread) {
                console.log('No current thread, creating new one');
                await createNewThread();
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('ì„œë²„ì™€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('Current thread:', currentThread);

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // ë¡œë”© í‘œì‹œ
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner"></div>';

            try {
                sendWebSocketMessage({
                    type: 'CHAT',
                    text: message,
                    userId: 'user',
                    lang: window.i18n ? window.i18n.getLanguageCode(window.i18n.getCurrentLanguage()) : 'KOREAN',
                    roomId: currentThread.id
                });

                lastAIMessageContent = '';
                const tempMessage = {
                    role: 'ai',
                    content: '...',
                    timestamp: new Date().toISOString(),
                    finalized: false
                };
                currentThread.messages.push(tempMessage);
                renderMessages();
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('ai', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                `;
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(role, content) {
            console.log('Adding message:', role, content);
            if (!currentThread) {
                console.error('No current thread');
                return;
            }

            if (!currentThread.messages) {
                currentThread.messages = [];
            }

            const message = {
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            };

            currentThread.messages.push(message);
            currentThread.lastMessage = content.substring(0, 50);
            currentThread.messageCount = currentThread.messages.length;
            currentThread.updatedAt = new Date().toISOString();

            // ì œëª© ìë™ ìƒì„± (ì²« ë©”ì‹œì§€ì¼ ê²½ìš°)
            if (currentThread.messages.length === 1 && role === 'user') {
                currentThread.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
            }

            renderMessages();
            console.log('Message added successfully');
        }

        // í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleKeyDown(event) {
            // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ ë†’ì´ ì¡°ì ˆ
            setTimeout(() => {
                const textarea = event.target;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            }, 0);

            // í•œêµ­ì–´/ì¼ë³¸ì–´/ì¤‘êµ­ì–´ ë“± IME ì…ë ¥ ì¤‘ì¼ ë•ŒëŠ” Enter í‚¤ ë¬´ì‹œ
            if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) {
                event.preventDefault();
                const form = document.querySelector('.chat-input-form');
                if (form) {
                    // Form submit ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                    form.requestSubmit();
                }
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            // ë¡œê·¸ì¸ ì²´í¬
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                window.location.href = '/auth/login';
                return;
            }

            // ì–¸ì–´ ì ìš©
            if (window.i18n) {
                window.i18n.updatePageLanguage();
            }

            // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
            loadUserInfo();

            // WebSocket ì—°ê²°
            connectWebSocket();

            // ì±„íŒ… ëª©ë¡ ë Œë”ë§
            await renderThreadList();

            // ì²« ë²ˆì§¸ ìŠ¤ë ˆë“œê°€ ìˆìœ¼ë©´ ì„ íƒ
            const threads = await getChatThreads();
            if (threads.length > 0) {
                await selectThread(threads[0].id);
            } else {
                // ìŠ¤ë ˆë“œê°€ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœ í‘œì‹œ
                const emptyState = document.getElementById('emptyState');
                const welcomeBox = document.getElementById('welcomeBox');
                if (emptyState) emptyState.style.display = 'block';
                if (welcomeBox) welcomeBox.style.display = 'block';
            }
        });

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ WebSocket ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>

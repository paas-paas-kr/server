<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìƒë‹´ - ë‹¤ë¬¸í™” ê°€ì • ìƒë‹´ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="top-nav">
        <div class="top-nav-content">
            <div class="top-nav-logo">
                <span class="top-nav-logo-icon">ğŸŒ</span>
                <span data-i18n="nav.logo">ë‹¤ë¬¸í™” ê°€ì • ì§€ì›</span>
            </div>
            <div class="top-nav-menu">
                <a href="/home" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span data-i18n="nav.home">í™ˆ</span>
                </a>
                <a href="/chat" class="top-nav-item active">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span data-i18n="nav.chat">ì±„íŒ…</span>
                </a>
                <a href="/document" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span data-i18n="nav.document">ë¬¸ì„œ</span>
                </a>
                <a href="/mypage" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span data-i18n="nav.mypage">ë§ˆì´í˜ì´ì§€</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="chat-layout with-top-nav">
        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°”: ì±„íŒ… ìŠ¤ë ˆë“œ ëª©ë¡ -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="createNewThread()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span data-i18n="chat.newChat">ìƒˆë¡œìš´ ëŒ€í™”</span>
                </button>
            </div>

            <div class="chat-threads" id="chatThreads">
                <!-- ì±„íŒ… ìŠ¤ë ˆë“œ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <div class="sidebar-footer">
                <a href="/document" class="user-profile" style="text-decoration: none; margin-bottom: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span style="font-size: 14px;" data-i18n="chat.documentSummary">ë¬¸ì„œ ìš”ì•½</span>
                </a>
                <a href="/mypage" class="user-profile">
                    <div class="user-avatar" id="sidebarAvatar">ì‚¬</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarUserName" data-i18n="chat.user">ì‚¬ìš©ì</div>
                    </div>
                </a>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <div class="chat-main">
            <!-- ë‹¤ë¬¸í™” ê°€ì • ì•ˆë‚´ -->
            <div class="welcome-box" id="welcomeBox">
                <h3 style="color: #92400e; font-size: 24px; font-weight: 700; margin-bottom: 16px;" data-i18n="chat.welcomeTitle">ğŸŒ ë‹¤ë¬¸í™” ê°€ì •ì„ ìœ„í•œ AI ìƒë‹´ ì„œë¹„ìŠ¤</h3>
                <p style="color: #78350f; font-size: 16px; line-height: 1.6; margin-bottom: 24px;" data-i18n="chat.welcomeDesc">
                    ì•ˆë…•í•˜ì„¸ìš”! ì–¸ì–´ì™€ ë¬¸í™”ì˜ ì¥ë²½ ì—†ì´ í•„ìš”í•œ ë„ì›€ì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆë„ë¡ ë•ëŠ” AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.
                    í¸ì•ˆí•˜ê²Œ ê¶ê¸ˆí•˜ì‹  ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”.
                </p>
                <div class="feature-list">
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸ’¬</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature1.title">24ì‹œê°„ ìƒë‹´</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature1.desc">ì–¸ì œë“ ì§€ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸ“„</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature2.title">ë¬¸ì„œ ë„ì›€</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature2.desc">ë³µì¡í•œ ì„œë¥˜ë¥¼ ì‰½ê²Œ ì´í•´í•˜ì„¸ìš”</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸŒ</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature3.title">ë‹¤êµ­ì–´ ì§€ì›</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature3.desc">ëª¨êµ­ì–´ë¡œ í¸í•˜ê²Œ ì†Œí†µí•˜ì„¸ìš”</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 28px; margin-bottom: 8px;">ğŸ”’</div>
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;" data-i18n="chat.feature4.title">ì•ˆì „í•œ ìƒë‹´</div>
                        <div style="font-size: 13px; color: #a16207;" data-i18n="chat.feature4.desc">ê°œì¸ì •ë³´ê°€ ë³´í˜¸ë©ë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- ë¹ˆ ìƒíƒœ -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <h3 class="empty-title" data-i18n="chat.empty.title">ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</h3>
                    <p class="empty-text" data-i18n="chat.empty.text">ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <form class="chat-input-form" onsubmit="sendMessage(event)">
                        <textarea
                            class="chat-input"
                            id="messageInput"
                            data-i18n-placeholder="chat.placeholder"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button type="submit" class="send-btn" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentThread = null;

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        function loadUserInfo() {
            const defaultName = window.i18n ? window.i18n.translate('chat.user') : 'ì‚¬ìš©ì';
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || JSON.stringify({name: defaultName, email: "user@example.com"}));
            document.getElementById('sidebarUserName').textContent = userInfo.name || defaultName;
            document.getElementById('sidebarAvatar').textContent = (userInfo.name || defaultName).charAt(0);
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì±„íŒ… ìŠ¤ë ˆë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        function getChatThreads() {
            const threads = localStorage.getItem('chatThreads');
            return threads ? JSON.parse(threads) : [];
        }

        // ì±„íŒ… ìŠ¤ë ˆë“œ ëª©ë¡ ì €ì¥
        function saveChatThreads(threads) {
            localStorage.setItem('chatThreads', JSON.stringify(threads));
        }

        // ì±„íŒ… ëª©ë¡ ë Œë”ë§
        function renderThreadList() {
            console.log('Rendering thread list');
            const threads = getChatThreads();
            const chatThreads = document.getElementById('chatThreads');

            if (!chatThreads) {
                console.error('chatThreads element not found');
                return;
            }

            if (threads.length === 0) {
                const noThreadsText = window.i18n ? window.i18n.translate('chat.noThreads') : 'ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤';
                chatThreads.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 14px;">
                        ${noThreadsText}
                    </div>
                `;
                return;
            }

            const newConvText = window.i18n ? window.i18n.translate('chat.newConversation') : 'ìƒˆ ëŒ€í™”';
            chatThreads.innerHTML = threads.map(thread => {
                const titleText = thread.title || newConvText;
                const previewText = thread.lastMessage || newConvText;
                const isActive = currentThread && currentThread.id === thread.id;

                return `
                    <a href="#" class="thread-item ${isActive ? 'active' : ''}" onclick="selectThread('${thread.id}'); return false;">
                        <div class="thread-item-title">${titleText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        <div class="thread-item-preview">${previewText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                    </a>
                `;
            }).join('');
            console.log('Thread list rendered, total threads:', threads.length, 'active thread:', currentThread?.id);
        }

        // ìŠ¤ë ˆë“œ ì„ íƒ
        function selectThread(threadId) {
            console.log('Selecting thread:', threadId);
            const threads = getChatThreads();
            currentThread = threads.find(t => t.id === threadId);

            if (currentThread) {
                console.log('Thread found:', currentThread);
                // ìŠ¤ë ˆë“œ ì„ íƒ ì‹œ ì›°ì»´ ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
                const welcomeBox = document.getElementById('welcomeBox');
                if (welcomeBox) welcomeBox.style.display = 'none';

                renderThreadList(); // active ìƒíƒœ ì—…ë°ì´íŠ¸
                renderMessages(); // ë©”ì‹œì§€ ë Œë”ë§
            } else {
                console.error('Thread not found:', threadId);
            }
        }

        // ë©”ì‹œì§€ ë Œë”ë§
        function renderMessages() {
            console.log('Rendering messages');
            const messagesContainer = document.getElementById('chatMessages');
            const emptyState = document.getElementById('emptyState');
            const welcomeBox = document.getElementById('welcomeBox');

            if (!messagesContainer) {
                console.error('messagesContainer not found');
                return;
            }

            if (!currentThread || !currentThread.messages || currentThread.messages.length === 0) {
                console.log('No messages to display');
                if (emptyState) emptyState.style.display = 'none';
                if (welcomeBox) welcomeBox.style.display = 'block';
                messagesContainer.innerHTML = '';
                return;
            }

            console.log('Displaying', currentThread.messages.length, 'messages');
            if (emptyState) emptyState.style.display = 'none';
            if (welcomeBox) welcomeBox.style.display = 'none';

            // ê¸°ì¡´ ë©”ì‹œì§€ ìœ ì§€í•˜ë©´ì„œ ìƒˆ ë©”ì‹œì§€ ì¶”ê°€
            const userText = window.i18n ? window.i18n.translate('chat.user') : 'ë‚˜';
            messagesContainer.innerHTML = currentThread.messages.map(msg => `
                <div class="message ${msg.role}">
                    <div class="message-avatar">${msg.role === 'ai' ? 'AI' : userText}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                </div>
            `).join('');

            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 50);
        }

        // ìƒˆ ìŠ¤ë ˆë“œ ìƒì„±
        function createNewThread() {
            console.log('Creating new thread');
            const threads = getChatThreads();
            const newChatText = window.i18n ? window.i18n.translate('chat.newChat') : 'ìƒˆë¡œìš´ ëŒ€í™”';
            const newThread = {
                id: Date.now().toString(),
                title: newChatText,
                lastMessage: '',
                messageCount: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                messages: []
            };

            threads.unshift(newThread);
            saveChatThreads(threads);
            currentThread = newThread;

            // ìƒˆ ëŒ€í™” ì‹œì‘ ì‹œ ì›°ì»´ ë°•ìŠ¤ í‘œì‹œ
            const welcomeBox = document.getElementById('welcomeBox');
            if (welcomeBox) welcomeBox.style.display = 'block';

            renderThreadList();
            renderMessages();

            // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            document.getElementById('messageInput').focus();
            console.log('New thread created:', newThread);
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage(event) {
            event.preventDefault();
            console.log('Send message triggered');

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            console.log('Message:', message);
            if (!message) {
                console.log('Empty message, returning');
                return;
            }

            // í˜„ì¬ ìŠ¤ë ˆë“œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (!currentThread) {
                console.log('No current thread, creating new one');
                createNewThread();
            }

            console.log('Current thread:', currentThread);

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // ë¡œë”© í‘œì‹œ
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner"></div>';

            // AI ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
            try {
                await simulateAIResponse(message);
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('ai', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                `;
            }
        }

        // AI ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜
        async function simulateAIResponse(userMessage) {
            await new Promise(resolve => setTimeout(resolve, 1000));

            let aiResponse = '';

            if (userMessage.includes('ì•ˆë…•') || userMessage.includes('í•˜ì´') || userMessage.includes('hi')) {
                aiResponse = 'ì•ˆë…•í•˜ì„¸ìš”! ë‹¤ë¬¸í™” ê°€ì • ìƒë‹´ AIì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?';
            } else if (userMessage.includes('ë„ì™€') || userMessage.includes('ë„ì›€')) {
                aiResponse = 'ë„¤, ê¸°êº¼ì´ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë¶€ë¶„ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?';
            } else if (userMessage.includes('ë¬¸ì„œ') || userMessage.includes('ì„œë¥˜')) {
                aiResponse = 'ë¬¸ì„œ ê´€ë ¨ ë„ì›€ì´ í•„ìš”í•˜ì‹œêµ°ìš”. ì™¼ìª½ í•˜ë‹¨ì˜ "ë¬¸ì„œ ìš”ì•½" ë©”ë‰´ì—ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì‹œë©´ ë‚´ìš©ì„ ìš”ì•½í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            } else {
                aiResponse = `"${userMessage}"ì— ëŒ€í•´ ë§ì”€í•˜ì…¨êµ°ìš”. ë” ìì„¸íˆ ì„¤ëª…í•´ì£¼ì‹œë©´ ë” ë‚˜ì€ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            }

            addMessage('ai', aiResponse);
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(role, content) {
            console.log('Adding message:', role, content);
            if (!currentThread) {
                console.error('No current thread');
                return;
            }

            if (!currentThread.messages) {
                currentThread.messages = [];
            }

            const message = {
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            };

            currentThread.messages.push(message);
            currentThread.lastMessage = content.substring(0, 50);
            currentThread.messageCount = currentThread.messages.length;
            currentThread.updatedAt = new Date().toISOString();

            // ì œëª© ìë™ ìƒì„± (ì²« ë©”ì‹œì§€ì¼ ê²½ìš°)
            if (currentThread.messages.length === 1 && role === 'user') {
                currentThread.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
            }

            saveThread();
            renderMessages();
            renderThreadList();
            console.log('Message added successfully');
        }

        // ìŠ¤ë ˆë“œ ì €ì¥
        function saveThread() {
            const threads = getChatThreads();
            const index = threads.findIndex(t => t.id === currentThread.id);

            if (index >= 0) {
                threads[index] = currentThread;
            } else {
                threads.unshift(currentThread);
            }

            saveChatThreads(threads);
        }

        // í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleKeyDown(event) {
            // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ ë†’ì´ ì¡°ì ˆ
            setTimeout(() => {
                const textarea = event.target;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            }, 0);

            // í•œêµ­ì–´/ì¼ë³¸ì–´/ì¤‘êµ­ì–´ ë“± IME ì…ë ¥ ì¤‘ì¼ ë•ŒëŠ” Enter í‚¤ ë¬´ì‹œ
            if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) {
                event.preventDefault();
                const form = document.querySelector('.chat-input-form');
                if (form) {
                    // Form submit ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                    form.requestSubmit();
                }
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ë¡œê·¸ì¸ ì²´í¬
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                window.location.href = '/auth/login';
                return;
            }

            // ì–¸ì–´ ì ìš©
            if (window.i18n) {
                window.i18n.updatePageLanguage();
            }

            // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
            loadUserInfo();

            // ì±„íŒ… ëª©ë¡ ë Œë”ë§
            renderThreadList();

            // ì²« ë²ˆì§¸ ìŠ¤ë ˆë“œê°€ ìˆìœ¼ë©´ ì„ íƒ
            const threads = getChatThreads();
            if (threads.length > 0) {
                selectThread(threads[0].id);
            } else {
                // ìŠ¤ë ˆë“œê°€ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœ í‘œì‹œ
                const emptyState = document.getElementById('emptyState');
                const welcomeBox = document.getElementById('welcomeBox');
                if (emptyState) emptyState.style.display = 'block';
                if (welcomeBox) welcomeBox.style.display = 'block';
            }
        });
    </script>

    <script src="/js/i18n.js"></script>
</body>
</html>

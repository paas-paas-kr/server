<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 상담 - 다문화 가정 상담 서비스</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="chat-container">
        <!-- 채팅 헤더 -->
        <div class="chat-header">
            <button class="back-btn" onclick="goBack()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="chat-title" id="chatTitle">AI 상담사</div>
        </div>

        <!-- 메시지 영역 -->
        <div class="chat-messages" id="chatMessages">
            <!-- 메시지가 여기에 동적으로 추가됩니다 -->
        </div>

        <!-- 입력 영역 -->
        <div class="chat-input-container">
            <form class="chat-input-form" onsubmit="sendMessage(event)">
                <textarea
                    class="chat-input"
                    id="messageInput"
                    placeholder="메시지를 입력하세요..."
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                ></textarea>
                <button type="submit" class="send-btn" id="sendBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        const threadId = /*[[${threadId}]]*/ '';
        let currentThread = null;

        // 스레드 데이터 로드
        function loadThread() {
            const threads = JSON.parse(localStorage.getItem('chatThreads') || '[]');
            currentThread = threads.find(t => t.id === threadId);

            if (!currentThread) {
                // 스레드가 없으면 생성
                currentThread = {
                    id: threadId,
                    title: '새 대화',
                    lastMessage: '',
                    messageCount: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    messages: []
                };
                threads.unshift(currentThread);
                localStorage.setItem('chatThreads', JSON.stringify(threads));
            }

            document.getElementById('chatTitle').textContent = currentThread.title;
            renderMessages();
        }

        // 메시지 렌더링
        function renderMessages() {
            const messagesContainer = document.getElementById('chatMessages');

            if (!currentThread.messages || currentThread.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <h3 class="empty-title">대화를 시작해보세요</h3>
                        <p class="empty-text">궁금한 것을 물어보세요</p>
                    </div>
                `;
                return;
            }

            messagesContainer.innerHTML = currentThread.messages.map(msg => `
                <div class="message ${msg.role}">
                    ${msg.role === 'ai' ? '<div class="message-avatar">AI</div>' : ''}
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                    ${msg.role === 'user' ? '<div class="message-avatar">나</div>' : ''}
                </div>
            `).join('');

            // 스크롤을 맨 아래로
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // 메시지 전송
        async function sendMessage(event) {
            event.preventDefault();

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // 사용자 메시지 추가
            addMessage('user', message);
            input.value = '';

            // 입력 필드 높이 초기화
            input.style.height = 'auto';

            // 로딩 표시
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="spinner"></div>';

            // AI 응답 시뮬레이션 (실제로는 API 호출)
            try {
                // TODO: 실제 API 호출로 교체
                await simulateAIResponse(message);
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('ai', '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                `;
            }
        }

        // AI 응답 시뮬레이션
        async function simulateAIResponse(userMessage) {
            await new Promise(resolve => setTimeout(resolve, 1000));

            // 간단한 응답 로직
            let aiResponse = '';

            if (userMessage.includes('안녕') || userMessage.includes('하이') || userMessage.includes('hi')) {
                aiResponse = '안녕하세요! 다문화 가정 상담 AI입니다. 무엇을 도와드릴까요?';
            } else if (userMessage.includes('도와') || userMessage.includes('도움')) {
                aiResponse = '네, 기꺼이 도와드리겠습니다. 구체적으로 어떤 부분이 궁금하신가요?';
            } else if (userMessage.includes('문서') || userMessage.includes('서류')) {
                aiResponse = '문서 관련 도움이 필요하시군요. 문서 메뉴에서 파일을 업로드하시면 내용을 요약해드릴 수 있습니다.';
            } else {
                aiResponse = `"${userMessage}"에 대해 말씀하셨군요. 더 자세히 설명해주시면 더 나은 답변을 드릴 수 있습니다.`;
            }

            addMessage('ai', aiResponse);
        }

        // 메시지 추가
        function addMessage(role, content) {
            if (!currentThread.messages) {
                currentThread.messages = [];
            }

            const message = {
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            };

            currentThread.messages.push(message);
            currentThread.lastMessage = content.substring(0, 50);
            currentThread.messageCount = currentThread.messages.length;
            currentThread.updatedAt = new Date().toISOString();

            // 제목 자동 생성 (첫 메시지일 경우)
            if (currentThread.messages.length === 1 && role === 'user') {
                currentThread.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                document.getElementById('chatTitle').textContent = currentThread.title;
            }

            saveThread();
            renderMessages();
        }

        // 스레드 저장
        function saveThread() {
            const threads = JSON.parse(localStorage.getItem('chatThreads') || '[]');
            const index = threads.findIndex(t => t.id === threadId);

            if (index >= 0) {
                threads[index] = currentThread;
            } else {
                threads.unshift(currentThread);
            }

            localStorage.setItem('chatThreads', JSON.stringify(threads));
        }

        // 키 이벤트 처리
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }

            // 텍스트 영역 자동 높이 조절
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // 뒤로 가기
        function goBack() {
            window.location.href = '/chat';
        }

        // 페이지 로드 시 스레드 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadThread();
        });
    </script>
</body>
</html>

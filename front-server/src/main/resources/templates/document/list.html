<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸ì„œ ìš”ì•½ - ë‹¤ë¬¸í™” ê°€ì • ìƒë‹´ ì„œë¹„ìŠ¤</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>
<body>
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="top-nav">
        <div class="top-nav-content">
            <div class="top-nav-logo">
                <span class="top-nav-logo-icon">ğŸŒ</span>
                <span data-i18n="nav.logo">ë‹¤ë¬¸í™” ê°€ì • ì§€ì›</span>
            </div>
            <div class="top-nav-menu">
                <a href="/home" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span data-i18n="nav.home">í™ˆ</span>
                </a>
                <a href="/chat" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span data-i18n="nav.chat">ì±„íŒ…</span>
                </a>
                <a href="/document" class="top-nav-item active">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span data-i18n="nav.document">ë¬¸ì„œ</span>
                </a>
                <a href="/mypage" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span data-i18n="nav.mypage">ë§ˆì´í˜ì´ì§€</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="app-container with-top-nav">
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="app-content">
            <!-- ë‹¤ë¬¸í™” ê°€ì • ì•ˆë‚´ -->
            <div class="info-box">
                <h3 style="color: #92400e; font-size: 20px; font-weight: 700; margin-bottom: 12px;" data-i18n="document.infoTitle">ğŸ“„ ë‹¤ë¬¸í™” ê°€ì •ì„ ìœ„í•œ ë¬¸ì„œ ìš”ì•½ ì„œë¹„ìŠ¤</h3>
                <p style="color: #78350f; font-size: 15px; line-height: 1.7; margin-bottom: 20px;" data-i18n="document.infoDesc">
                    ë³µì¡í•œ í•œêµ­ ì„œë¥˜, ê³µë¬¸ì„œ, ì•ˆë‚´ë¬¸ì´ ì–´ë ¤ìš°ì‹ ê°€ìš”?<br>
                    AIê°€ ë¬¸ì„œì˜ í•µì‹¬ ë‚´ìš©ì„ ì‰½ê³  ê°„ë‹¨í•˜ê²Œ ìš”ì•½í•´ë“œë¦½ë‹ˆë‹¤.
                </p>
                <div class="feature-list" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="feature-item">
                        <div style="font-size: 24px; margin-bottom: 6px;">ğŸ”</div>
                        <div style="font-weight: 600; color: #92400e; font-size: 14px; margin-bottom: 4px;" data-i18n="document.feature1.title">ìë™ ìš”ì•½</div>
                        <div style="font-size: 12px; color: #a16207;" data-i18n="document.feature1.desc">í•µì‹¬ë§Œ ë¹ ë¥´ê²Œ íŒŒì•…</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 24px; margin-bottom: 6px;">ğŸŒ</div>
                        <div style="font-weight: 600; color: #92400e; font-size: 14px; margin-bottom: 4px;" data-i18n="document.feature2.title">ë‹¤êµ­ì–´ ì§€ì›</div>
                        <div style="font-size: 12px; color: #a16207;" data-i18n="document.feature2.desc">ëª¨êµ­ì–´ë¡œ ì´í•´í•˜ê¸°</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 24px; margin-bottom: 6px;">âš¡</div>
                        <div style="font-weight: 600; color: #92400e; font-size: 14px; margin-bottom: 4px;" data-i18n="document.feature3.title">ë¹ ë¥¸ ì²˜ë¦¬</div>
                        <div style="font-size: 12px; color: #a16207;" data-i18n="document.feature3.desc">ëª‡ ì´ˆ ë§Œì— ì™„ë£Œ</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 24px; margin-bottom: 6px;">ğŸ’¾</div>
                        <div style="font-weight: 600; color: #92400e; font-size: 14px; margin-bottom: 4px;" data-i18n="document.feature4.title">ì•ˆì „ ë³´ê´€</div>
                        <div style="font-size: 12px; color: #a16207;" data-i18n="document.feature4.desc">ì–¸ì œë“  ë‹¤ì‹œ í™•ì¸</div>
                    </div>
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ì˜ì—­ -->
            <div class="card">
                <div class="upload-area" id="uploadArea">
                    <div id="uploadAreaContent" onclick="document.getElementById('fileInput').click()" style="display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 100%;">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <div class="upload-text" data-i18n="document.upload">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                        <div class="upload-hint" data-i18n="document.uploadHint">PDF, DOC, DOCX, TXT, JPG, PNG íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤ (ì´ë¯¸ì§€ëŠ” ì—¬ëŸ¬ ê°œ ê°€ëŠ¥, ìµœëŒ€ 10MB)</div>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.bmp,.webp" multiple onchange="showFilePreview(event)">
                </div>

                <!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                <div id="filePreviewArea" style="display: none; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1f2937;">ì„ íƒëœ íŒŒì¼</h3>
                        <button onclick="document.getElementById('fileInput').click()" style="padding: 8px 16px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; cursor: pointer; color: #374151;">íŒŒì¼ ì¶”ê°€</button>
                    </div>
                    <div id="fileList" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="uploadSelectedFiles()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px 0 rgba(245, 158, 11, 0.25);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px -5px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px 0 rgba(245, 158, 11, 0.25)'">ì—…ë¡œë“œ</button>
                        <button onclick="cancelUpload()" style="padding: 12px 24px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; color: #374151; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>

            <!-- ë¬¸ì„œ ëª©ë¡ -->
            <div class="card">
                <h2 class="card-title" data-i18n="document.myDocuments">ë‚´ ë¬¸ì„œ</h2>
                <div id="documentList">
                    <!-- ë¬¸ì„œ ì•„ì´í…œì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>

                <!-- ë¹ˆ ìƒíƒœ -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <h3 class="empty-title" data-i18n="document.empty.title">ì—…ë¡œë“œí•œ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p class="empty-text" data-i18n="document.empty.text">ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ìš”ì•½í•´ë“œë¦½ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ìš”ì•½ ëª¨ë‹¬ -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle" data-i18n="document.title">ë¬¸ì„œ ìš”ì•½</h2>
                <button class="modal-close" onclick="closeSummaryModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script>
        // ì„ íƒëœ íŒŒì¼ë“¤ì„ ì €ì¥í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
        let selectedFiles = [];

        // APIì—ì„œ ë¬¸ì„œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function getDocuments() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/documents`, {
                    method: 'GET',
                    headers: window.getAuthHeaders(),
                    credentials: 'include'
                });

                if (!response.ok) {
                    console.error('Failed to fetch documents:', response.status);
                    return [];
                }

                const result = await response.json();
                return result.data || [];
            } catch (error) {
                console.error('Error fetching documents:', error);
                return [];
            }
        }

        // ë¬¸ì„œ ëª©ë¡ ë Œë”ë§
        async function renderDocuments() {
            const docs = await getDocuments();
            const documentList = document.getElementById('documentList');
            const emptyState = document.getElementById('emptyState');

            if (docs.length === 0) {
                documentList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            documentList.innerHTML = docs.map(doc => {
                const fileName = doc.fileNames && doc.fileNames.length > 0 ? doc.fileNames.join(', ') : 'íŒŒì¼ëª… ì—†ìŒ';
                const statusBadge = getStatusBadge(doc.status);

                return `
                <div class="document-item">
                    <div class="doc-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                    </div>
                    <div class="doc-info">
                        <div class="doc-title">${fileName}</div>
                        <div class="doc-meta">${statusBadge} â€¢ ${formatDate(doc.uploadedAt)}</div>
                    </div>
                    <div class="doc-actions">
                        ${doc.status === 'COMPLETED' ? `
                        <button class="icon-btn" onclick="viewSummary(${doc.jobId})" title="ìš”ì•½ ë³´ê¸°">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                        ` : `
                        <button class="icon-btn" onclick="checkStatus(${doc.jobId})" title="ìƒíƒœ í™•ì¸">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>
                        </button>
                        `}
                    </div>
                </div>
            `}).join('');
        }

        // ìƒíƒœ ë°°ì§€ ìƒì„±
        function getStatusBadge(status) {
            const badges = {
                'PENDING': '<span style="color: #f59e0b; font-weight: 600;">â³ ëŒ€ê¸° ì¤‘</span>',
                'PROCESSING': '<span style="color: #3b82f6; font-weight: 600;">âš™ï¸ ì²˜ë¦¬ ì¤‘</span>',
                'COMPLETED': '<span style="color: #10b981; font-weight: 600;">âœ… ì™„ë£Œ</span>',
                'FAILED': '<span style="color: #ef4444; font-weight: 600;">âŒ ì‹¤íŒ¨</span>'
            };
            return badges[status] || status;
        }

        // íŒŒì¼ì´ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸
        function isImageFile(file) {
            const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
            return imageTypes.includes(file.type.toLowerCase());
        }

        // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function showFilePreview(event) {
            const newFiles = Array.from(event.target.files);
            if (newFiles.length === 0) return;

            // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
            for (const file of newFiles) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`${file.name}: íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    event.target.value = '';
                    return;
                }
            }

            // ê¸°ì¡´ íŒŒì¼ì´ ìˆëŠ” ê²½ìš° íƒ€ì… ê²€ì‚¬
            if (selectedFiles.length > 0) {
                const existingIsImage = isImageFile(selectedFiles[0]);
                const newIsImage = isImageFile(newFiles[0]);

                // ì´ë¯¸ì§€ì™€ ë¬¸ì„œë¥¼ ì„ì„ ìˆ˜ ì—†ìŒ
                if (existingIsImage !== newIsImage) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ê³¼ ë¬¸ì„œ íŒŒì¼ì„ í•¨ê»˜ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜„ì¬ ì„ íƒëœ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜ ì·¨ì†Œí•´ì£¼ì„¸ìš”.');
                    event.target.value = '';
                    return;
                }

                // ë¬¸ì„œ íŒŒì¼ì€ í•˜ë‚˜ë§Œ ê°€ëŠ¥
                if (!existingIsImage) {
                    alert('ë¬¸ì„œ íŒŒì¼ì€ í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ì„ íƒëœ ë¬¸ì„œë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ê±°ë‚˜ ì·¨ì†Œí•´ì£¼ì„¸ìš”.');
                    event.target.value = '';
                    return;
                }
            } else {
                // ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ë“¤ë¼ë¦¬ì˜ íƒ€ì… ê²€ì‚¬
                const allImages = newFiles.every(f => isImageFile(f));
                const allDocuments = newFiles.every(f => !isImageFile(f));

                if (!allImages && !allDocuments) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ê³¼ ë¬¸ì„œ íŒŒì¼ì„ í•¨ê»˜ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¯¸ì§€ë§Œ ë˜ëŠ” ë¬¸ì„œë§Œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    event.target.value = '';
                    return;
                }

                // ë¬¸ì„œ íŒŒì¼ì€ í•˜ë‚˜ë§Œ ê°€ëŠ¥
                if (allDocuments && newFiles.length > 1) {
                    alert('ë¬¸ì„œ íŒŒì¼ì€ í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    event.target.value = '';
                    return;
                }
            }

            // íŒŒì¼ ì¶”ê°€
            selectedFiles = selectedFiles.concat(newFiles);

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            updateFilePreview();

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateFilePreview() {
            const filePreviewArea = document.getElementById('filePreviewArea');
            const fileList = document.getElementById('fileList');
            const uploadAreaContent = document.getElementById('uploadAreaContent');

            if (selectedFiles.length === 0) {
                filePreviewArea.style.display = 'none';
                uploadAreaContent.style.display = 'flex';
                return;
            }

            uploadAreaContent.style.display = 'none';
            filePreviewArea.style.display = 'block';

            const isImage = isImageFile(selectedFiles[0]);
            const fileType = isImage ? 'ì´ë¯¸ì§€' : 'ë¬¸ì„œ';

            fileList.innerHTML = selectedFiles.map((file, index) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="font-size: 24px;">${isImage ? 'ğŸ–¼ï¸' : 'ğŸ“„'}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 14px; font-weight: 500; color: #1f2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</div>
                            <div style="font-size: 12px; color: #6b7280;">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" style="padding: 6px; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; color: #dc2626; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                </div>
            `).join('');
        }

        // íŒŒì¼ ì œê±°
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
        }

        // ì—…ë¡œë“œ ì·¨ì†Œ
        function cancelUpload() {
            selectedFiles = [];
            updateFilePreview();
        }

        // ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œ
        async function uploadSelectedFiles() {
            if (selectedFiles.length === 0) {
                alert('ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const files = selectedFiles;
            const fileCount = files.length;
            const fileNames = files.map(f => f.name).join(', ');

            // íŒŒì¼ íƒ€ì… ê²€ì‚¬
            const allImages = files.every(f => isImageFile(f));
            const allDocuments = files.every(f => !isImageFile(f));
            const isMultipleImages = allImages && files.length > 1;

            console.log('ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', fileCount + 'ê°œ', fileNames);

            // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ìˆ¨ê¸°ê¸°
            const filePreviewArea = document.getElementById('filePreviewArea');
            filePreviewArea.style.display = 'none';

            // íŒŒì¼ ì—…ë¡œë“œ UI í‘œì‹œ
            const uploadAreaContent = document.getElementById('uploadAreaContent');
            uploadAreaContent.style.display = 'flex';
            uploadAreaContent.onclick = null; // ì—…ë¡œë“œ ì¤‘ì—ëŠ” í´ë¦­ ë¹„í™œì„±í™”
            uploadAreaContent.innerHTML = `
                <div class="spinner" style="width: 50px; height: 50px; border-width: 5px; border-color: #f59e0b; border-top-color: transparent; margin: 0 auto 20px;"></div>
                <div class="upload-text">ì—…ë¡œë“œ ì¤‘... (${fileCount}ê°œ)</div>
                <div class="upload-hint">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
            `;

            try {
                // ì‹¤ì œ API í˜¸ì¶œ
                const formData = new FormData();

                let apiUrl;
                if (isMultipleImages) {
                    // ì—¬ëŸ¬ ì´ë¯¸ì§€ íŒŒì¼ì€ ì´ë¯¸ì§€ ì—…ë¡œë“œ API ì‚¬ìš©
                    files.forEach(file => {
                        formData.append('images', file);
                    });
                    apiUrl = `${window.API_BASE_URL}/api/documents/upload/images`;
                    console.log('ğŸš€ ì´ë¯¸ì§€ API í˜¸ì¶œ ì‹œì‘ (ì—¬ëŸ¬ íŒŒì¼):', apiUrl, fileCount + 'ê°œ');
                } else if (allImages) {
                    // ë‹¨ì¼ ì´ë¯¸ì§€ë„ ì´ë¯¸ì§€ API ì‚¬ìš©
                    formData.append('images', files[0]);
                    apiUrl = `${window.API_BASE_URL}/api/documents/upload/images`;
                    console.log('ğŸš€ ì´ë¯¸ì§€ API í˜¸ì¶œ ì‹œì‘ (ë‹¨ì¼ íŒŒì¼):', apiUrl);
                } else {
                    // ë¬¸ì„œ íŒŒì¼ì€ ë¬¸ì„œ ì—…ë¡œë“œ API ì‚¬ìš©
                    formData.append('file', files[0]);
                    apiUrl = `${window.API_BASE_URL}/api/documents/upload/files`;
                    console.log('ğŸš€ ë¬¸ì„œ API í˜¸ì¶œ ì‹œì‘:', apiUrl);
                }

                // FormData ì‚¬ìš© ì‹œ Authorization í—¤ë”ë§Œ ì¶”ê°€ (Content-Typeì€ ìë™ ì„¤ì •ë¨)
                const token = localStorage.getItem('accessToken');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: formData,
                    credentials: 'include'
                });

                console.log('ğŸ“¥ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

                // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € í™•ì¸
                const responseText = await response.text();
                console.log('ğŸ“¥ ì‘ë‹µ í…ìŠ¤íŠ¸:', responseText);

                let result;
                try {
                    result = responseText ? JSON.parse(responseText) : {};
                } catch (jsonError) {
                    console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', jsonError);
                    throw new Error('ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                console.log('ğŸ“‹ ì‘ë‹µ ë°ì´í„°:', result);

                if (!response.ok) {
                    const errorMsg = result.error || result.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨';
                    console.error('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:', errorMsg);
                    throw new Error(errorMsg);
                }

                console.log('âœ… ì—…ë¡œë“œ ì„±ê³µ! JobID:', result.data?.jobId);

                // ì„±ê³µ ë©”ì‹œì§€
                const fileTypeMsg = allImages ? (isMultipleImages ? `ì´ë¯¸ì§€ ${fileCount}ê°œ` : 'ì´ë¯¸ì§€') : 'ë¬¸ì„œ';
                uploadAreaContent.innerHTML = `
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <div class="upload-text" style="color: #10b981;">ì—…ë¡œë“œ ì™„ë£Œ!</div>
                    <div class="upload-hint">${fileTypeMsg} ë¶„ì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ (Job ID: ${result.data?.jobId || 'N/A'})</div>
                `;

                // ì„ íƒëœ íŒŒì¼ ì´ˆê¸°í™”
                selectedFiles = [];

                setTimeout(() => {
                    resetUploadArea();
                    console.log('ğŸ”„ ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨');
                    renderDocuments();
                }, 2000);

            } catch (error) {
                console.error('âŒ Upload error:', error);

                // ì„ íƒëœ íŒŒì¼ ì´ˆê¸°í™”
                selectedFiles = [];

                uploadAreaContent.innerHTML = `
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <div class="upload-text" style="color: #ef4444;">ì—…ë¡œë“œ ì‹¤íŒ¨</div>
                    <div class="upload-hint" style="color: #ef4444;">${error.message || 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'}</div>
                `;
                setTimeout(resetUploadArea, 3000);
            }
        }

        // ì—…ë¡œë“œ ì˜ì—­ ì´ˆê¸°í™”
        function resetUploadArea() {
            const uploadAreaContent = document.getElementById('uploadAreaContent');
            uploadAreaContent.style.display = 'flex';
            uploadAreaContent.innerHTML = `
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div class="upload-text">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                <div class="upload-hint">PDF, DOC, DOCX, TXT, JPG, PNG íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤ (ì´ë¯¸ì§€ëŠ” ì—¬ëŸ¬ ê°œ ê°€ëŠ¥, ìµœëŒ€ 10MB)</div>
            `;

            // onclick í•¸ë“¤ëŸ¬ ë‹¤ì‹œ ì¶”ê°€
            uploadAreaContent.onclick = function() {
                document.getElementById('fileInput').click();
            };
        }

        // ìš”ì•½ ë³´ê¸°
        async function viewSummary(jobId) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/documents/${jobId}/summary`, {
                    method: 'GET',
                    headers: window.getAuthHeaders(),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('ìš”ì•½ ì¡°íšŒ ì‹¤íŒ¨');
                }

                const result = await response.json();
                const summary = result.data.summary;

                // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
                const htmlContent = marked.parse(summary);

                document.getElementById('modalTitle').textContent = 'ë¬¸ì„œ ìš”ì•½';
                document.getElementById('modalContent').innerHTML = `
                    <div class="markdown-content">
                        ${htmlContent}
                    </div>
                `;
                document.getElementById('summaryModal').classList.add('open');
            } catch (error) {
                console.error('Error fetching summary:', error);
                alert('ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìƒíƒœ í™•ì¸
        async function checkStatus(jobId) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/documents/${jobId}/status`, {
                    method: 'GET',
                    headers: window.getAuthHeaders(),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨');
                }

                const result = await response.json();
                alert(`ìƒíƒœ: ${result.data.statusMessage}`);

                // ì™„ë£Œë˜ì—ˆìœ¼ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                if (result.data.statusMessage.includes('ì™„ë£Œ')) {
                    renderDocuments();
                }
            } catch (error) {
                console.error('Error checking status:', error);
                alert('ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeSummaryModal() {
            document.getElementById('summaryModal').classList.remove('open');
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#d97706';
            uploadArea.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%)';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#f59e0b';
            uploadArea.style.background = 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#f59e0b';
            uploadArea.style.background = 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('fileInput');
                fileInput.files = files;
                showFilePreview({ target: fileInput });
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¬¸ì„œ ëª©ë¡ ë Œë”ë§
        document.addEventListener('DOMContentLoaded', function() {
            renderDocuments();
        });
    </script>

    <script src="/js/i18n.js"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ì²´í¬ ë° ì–¸ì–´ ì ìš©
        document.addEventListener('DOMContentLoaded', function() {
            // ë¡œê·¸ì¸ ì²´í¬
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                window.location.href = '/auth/login';
                return;
            }

            // ì–¸ì–´ ì ìš©
            if (window.i18n) {
                window.i18n.updatePageLanguage();
            }
        });
    </script>
</body>
</html>

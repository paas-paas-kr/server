<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문서 요약 - 다문화 가정 상담 서비스</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>
<body>
    <!-- 상단 네비게이션 -->
    <nav class="top-nav">
        <div class="top-nav-content">
            <div class="top-nav-logo">
                <span class="top-nav-logo-icon">🏠</span>
                <span data-i18n="nav.logo">온가</span>
            </div>
            <div class="top-nav-menu">
                <a href="/home" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span data-i18n="nav.home">홈</span>
                </a>
                <a href="/chat" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span data-i18n="nav.chat">채팅</span>
                </a>
                <a href="/document" class="top-nav-item active">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <span data-i18n="nav.document">문서</span>
                </a>
                <a href="/mypage" class="top-nav-item">
                    <svg class="top-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span data-i18n="nav.mypage">마이페이지</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="app-container with-top-nav">
        <!-- 메인 컨텐츠 -->
        <div class="app-content">
            <!-- 다문화 가정 안내 -->
            <div class="info-box">
                <h3 style="color: #92400e; font-size: 20px; font-weight: 700; margin-bottom: 12px;" data-i18n="document.infoTitle">📄 다문화 가정을 위한 문서 요약 서비스</h3>
                <p style="color: #78350f; font-size: 15px; line-height: 1.7; margin-bottom: 20px;" data-i18n="document.infoDesc">
                    복잡한 한국 서류, 공문서, 안내문이 어려우신가요?<br>
                    AI가 문서의 핵심 내용을 쉽고 간단하게 요약해드립니다.
                </p>
                <div class="feature-list" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="feature-item">
                        <div style="font-size: 24px; margin-bottom: 6px;">🔍</div>
                        <div style="font-weight: 600; color: #92400e; font-size: 14px; margin-bottom: 4px;" data-i18n="document.feature1.title">자동 요약</div>
                        <div style="font-size: 12px; color: #a16207;" data-i18n="document.feature1.desc">핵심만 빠르게 파악</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 24px; margin-bottom: 6px;">🌐</div>
                        <div style="font-weight: 600; color: #92400e; font-size: 14px; margin-bottom: 4px;" data-i18n="document.feature2.title">다국어 지원</div>
                        <div style="font-size: 12px; color: #a16207;" data-i18n="document.feature2.desc">모국어로 이해하기</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 24px; margin-bottom: 6px;">⚡</div>
                        <div style="font-weight: 600; color: #92400e; font-size: 14px; margin-bottom: 4px;" data-i18n="document.feature3.title">빠른 처리</div>
                        <div style="font-size: 12px; color: #a16207;" data-i18n="document.feature3.desc">몇 초 만에 완료</div>
                    </div>
                    <div class="feature-item">
                        <div style="font-size: 24px; margin-bottom: 6px;">💾</div>
                        <div style="font-weight: 600; color: #92400e; font-size: 14px; margin-bottom: 4px;" data-i18n="document.feature4.title">안전 보관</div>
                        <div style="font-size: 12px; color: #a16207;" data-i18n="document.feature4.desc">언제든 다시 확인</div>
                    </div>
                </div>
            </div>

            <!-- 사용 가이드 -->
            <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #fbbf24;">
                <h3 style="color: #92400e; font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <span>📖</span>
                    <span data-i18n="document.guide.title">사용 방법</span>
                </h3>
                <div style="display: grid; gap: 16px;">
                    <!-- Step 1 -->
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">1</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #92400e; font-size: 15px; margin-bottom: 4px;" data-i18n="document.guide.step1.title">파일 업로드</div>
                            <div style="color: #78350f; font-size: 14px; line-height: 1.6;" data-i18n="document.guide.step1.desc">아래 업로드 영역을 클릭하거나 파일을 드래그 앤 드롭하세요. PDF 또는 이미지 파일(JPG, PNG 등)을 지원합니다.</div>
                        </div>
                    </div>
                    <!-- Step 2 -->
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">2</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #92400e; font-size: 15px; margin-bottom: 4px;" data-i18n="document.guide.step2.title">자동 분석</div>
                            <div style="color: #78350f; font-size: 14px; line-height: 1.6;" data-i18n="document.guide.step2.desc">AI가 자동으로 문서를 읽고 중요한 내용을 추출합니다. 처리 시간은 문서 길이에 따라 다릅니다.</div>
                        </div>
                    </div>
                    <!-- Step 3 -->
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">3</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #92400e; font-size: 15px; margin-bottom: 4px;" data-i18n="document.guide.step3.title">요약 확인</div>
                            <div style="color: #78350f; font-size: 14px; line-height: 1.6;" data-i18n="document.guide.step3.desc">처리가 완료되면 '내 문서' 목록에서 요약 보기 버튼을 클릭하여 결과를 확인하세요.</div>
                        </div>
                    </div>
                    <!-- Step 4 -->
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">4</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #92400e; font-size: 15px; margin-bottom: 4px;" data-i18n="document.guide.step4.title">다국어 지원</div>
                            <div style="color: #78350f; font-size: 14px; line-height: 1.6;" data-i18n="document.guide.step4.desc">마이페이지에서 언어를 설정하면 요약 결과가 선택한 언어로 제공됩니다. (한국어, 영어, 일본어, 중국어, 베트남어 지원)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 업로드 영역 -->
            <div class="card">
                <div class="upload-area" id="uploadArea">
                    <div id="uploadAreaContent" onclick="document.getElementById('fileInput').click()" style="display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 100%;">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <div class="upload-text" data-i18n="document.upload">파일을 업로드하세요</div>
                        <div class="upload-hint" data-i18n="document.uploadHint">PDF 또는 이미지 파일(JPG, PNG 등)을 지원합니다 (이미지는 여러 개 가능, 최대 10MB)</div>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.webp" multiple onchange="showFilePreview(event)">
                </div>

                <!-- 파일 미리보기 영역 -->
                <div id="filePreviewArea" style="display: none; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1f2937;">선택된 파일</h3>
                        <button onclick="document.getElementById('fileInput').click()" style="padding: 8px 16px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; cursor: pointer; color: #374151;" data-i18n="document.button.addFile">파일 추가</button>
                    </div>
                    <div id="fileList" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <!-- 파일 목록이 여기에 표시됩니다 -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="uploadSelectedFiles()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px 0 rgba(245, 158, 11, 0.25);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px -5px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px 0 rgba(245, 158, 11, 0.25)'" data-i18n="document.button.upload">업로드</button>
                        <button onclick="cancelUpload()" style="padding: 12px 24px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; color: #374151; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'" data-i18n="document.button.cancel">취소</button>
                    </div>
                </div>
            </div>

            <!-- 문서 목록 -->
            <div class="card">
                <h2 class="card-title" data-i18n="document.myDocuments">내 문서</h2>
                <div id="documentList">
                    <!-- 문서 아이템이 여기에 동적으로 추가됩니다 -->
                </div>

                <!-- 빈 상태 -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <h3 class="empty-title" data-i18n="document.empty.title">업로드한 문서가 없습니다</h3>
                    <p class="empty-text" data-i18n="document.empty.text">문서를 업로드하면 AI가 자동으로 요약해드립니다</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 요약 모달 -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle" data-i18n="document.title">문서 요약</h2>
                <button class="modal-close" onclick="closeSummaryModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- 요약 내용이 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script>
        // 선택된 파일들을 저장하는 전역 변수
        let selectedFiles = [];

        // API에서 문서 목록 가져오기
        async function getDocuments() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/documents`, {
                    method: 'GET',
                    headers: window.getAuthHeaders(),
                    credentials: 'include'
                });

                if (!response.ok) {
                    console.error('Failed to fetch documents:', response.status);
                    return [];
                }

                const result = await response.json();
                return result.data || [];
            } catch (error) {
                console.error('Error fetching documents:', error);
                return [];
            }
        }

        // 문서 목록 렌더링
        async function renderDocuments() {
            const docs = await getDocuments();
            const documentList = document.getElementById('documentList');
            const emptyState = document.getElementById('emptyState');

            if (docs.length === 0) {
                documentList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            documentList.innerHTML = docs.map(doc => {
                const fileName = doc.fileNames && doc.fileNames.length > 0 ? doc.fileNames.join(', ') : '파일명 없음';
                const statusBadge = getStatusBadge(doc.status);

                return `
                <div class="document-item">
                    <div class="doc-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                    </div>
                    <div class="doc-info">
                        <div class="doc-title">${fileName}</div>
                        <div class="doc-meta">${statusBadge} • ${formatDate(doc.uploadedAt)}</div>
                    </div>
                    <div class="doc-actions">
                        ${doc.status === 'COMPLETED' ? `
                        <button class="icon-btn" onclick="viewSummary(${doc.jobId})" title="요약 보기">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                        ` : `
                        <button class="icon-btn" onclick="checkStatus(${doc.jobId})" title="상태 확인">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>
                        </button>
                        `}
                    </div>
                </div>
            `}).join('');
        }

        // 상태 배지 생성
        function getStatusBadge(status) {
            const pending = window.i18n ? window.i18n.translate('document.status.pending') : '⏳ 대기 중';
            const processing = window.i18n ? window.i18n.translate('document.status.processing') : '⚙️ 처리 중';
            const completed = window.i18n ? window.i18n.translate('document.status.completed') : '✅ 완료';
            const failed = window.i18n ? window.i18n.translate('document.status.failed') : '❌ 실패';

            const badges = {
                'PENDING': `<span style="color: #f59e0b; font-weight: 600;">${pending}</span>`,
                'PROCESSING': `<span style="color: #3b82f6; font-weight: 600;">${processing}</span>`,
                'COMPLETED': `<span style="color: #10b981; font-weight: 600;">${completed}</span>`,
                'FAILED': `<span style="color: #ef4444; font-weight: 600;">${failed}</span>`
            };
            return badges[status] || status;
        }

        // 파일이 이미지인지 확인
        function isImageFile(file) {
            const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
            return imageTypes.includes(file.type.toLowerCase());
        }

        // 파일 선택 시 미리보기 표시
        function showFilePreview(event) {
            const newFiles = Array.from(event.target.files);
            if (newFiles.length === 0) return;

            // 파일 크기 체크 (10MB)
            for (const file of newFiles) {
                if (file.size > 10 * 1024 * 1024) {
                    const errorMsg = window.i18n ? window.i18n.translate('document.error.fileSize') : '파일 크기는 10MB를 초과할 수 없습니다.';
                    alert(`${file.name}: ${errorMsg}`);
                    event.target.value = '';
                    return;
                }
            }

            // 기존 파일이 있는 경우 타입 검사
            if (selectedFiles.length > 0) {
                const existingIsImage = isImageFile(selectedFiles[0]);
                const newIsImage = isImageFile(newFiles[0]);

                // 이미지와 문서를 섞을 수 없음
                if (existingIsImage !== newIsImage) {
                    const errorMsg = window.i18n ? window.i18n.translate('document.error.mixedTypes') : '이미지 파일과 문서 파일을 함께 업로드할 수 없습니다.\n현재 선택된 파일을 먼저 업로드하거나 취소해주세요.';
                    alert(errorMsg);
                    event.target.value = '';
                    return;
                }

                // 문서 파일은 하나만 가능
                if (!existingIsImage) {
                    const errorMsg = window.i18n ? window.i18n.translate('document.error.singleDocument') : '문서 파일은 한 번에 하나만 업로드할 수 있습니다.\n현재 선택된 문서를 먼저 업로드하거나 취소해주세요.';
                    alert(errorMsg);
                    event.target.value = '';
                    return;
                }
            } else {
                // 새로 선택한 파일들끼리의 타입 검사
                const allImages = newFiles.every(f => isImageFile(f));
                const allDocuments = newFiles.every(f => !isImageFile(f));

                if (!allImages && !allDocuments) {
                    const errorMsg = window.i18n ? window.i18n.translate('document.error.mixedSelection') : '이미지 파일과 문서 파일을 함께 업로드할 수 없습니다.\n이미지만 또는 문서만 선택해주세요.';
                    alert(errorMsg);
                    event.target.value = '';
                    return;
                }

                // 문서 파일은 하나만 가능
                if (allDocuments && newFiles.length > 1) {
                    const errorMsg = window.i18n ? window.i18n.translate('document.error.multipleDocuments') : '문서 파일은 한 번에 하나만 업로드할 수 있습니다.';
                    alert(errorMsg);
                    event.target.value = '';
                    return;
                }
            }

            // 파일 추가
            selectedFiles = selectedFiles.concat(newFiles);

            // 미리보기 업데이트
            updateFilePreview();

            // 파일 입력 초기화
            event.target.value = '';
        }

        // 파일 미리보기 업데이트
        function updateFilePreview() {
            const filePreviewArea = document.getElementById('filePreviewArea');
            const fileList = document.getElementById('fileList');
            const uploadAreaContent = document.getElementById('uploadAreaContent');

            if (selectedFiles.length === 0) {
                filePreviewArea.style.display = 'none';
                uploadAreaContent.style.display = 'flex';
                return;
            }

            uploadAreaContent.style.display = 'none';
            filePreviewArea.style.display = 'block';

            const isImage = isImageFile(selectedFiles[0]);
            const fileType = isImage ? '이미지' : '문서';
            const deleteBtn = window.i18n ? window.i18n.translate('document.button.delete') : '삭제';

            fileList.innerHTML = selectedFiles.map((file, index) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="font-size: 24px;">${isImage ? '🖼️' : '📄'}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 14px; font-weight: 500; color: #1f2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</div>
                            <div style="font-size: 12px; color: #6b7280;">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" style="padding: 6px; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; color: #dc2626; cursor: pointer; font-size: 12px;">${deleteBtn}</button>
                </div>
            `).join('');
        }

        // 파일 제거
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
        }

        // 업로드 취소
        function cancelUpload() {
            selectedFiles = [];
            updateFilePreview();
        }

        // 실제 파일 업로드
        async function uploadSelectedFiles() {
            if (selectedFiles.length === 0) {
                const errorMsg = window.i18n ? window.i18n.translate('document.error.noFile') : '업로드할 파일을 선택해주세요.';
                alert(errorMsg);
                return;
            }

            const files = selectedFiles;
            const fileCount = files.length;
            const fileNames = files.map(f => f.name).join(', ');

            // 파일 타입 검사
            const allImages = files.every(f => isImageFile(f));
            const allDocuments = files.every(f => !isImageFile(f));
            const isMultipleImages = allImages && files.length > 1;

            console.log('📤 파일 업로드 시작:', fileCount + '개', fileNames);

            // 파일 미리보기 영역 숨기기
            const filePreviewArea = document.getElementById('filePreviewArea');
            filePreviewArea.style.display = 'none';

            // 파일 업로드 UI 표시
            const uploadAreaContent = document.getElementById('uploadAreaContent');
            uploadAreaContent.style.display = 'flex';
            uploadAreaContent.onclick = null; // 업로드 중에는 클릭 비활성화
            const uploadingText = window.i18n ? window.i18n.translate('document.uploading') : '업로드 중...';
            const uploadingCount = window.i18n ? window.i18n.translate('document.uploadingCount') : '개';
            const uploadingWait = window.i18n ? window.i18n.translate('document.uploadingWait') : '잠시만 기다려주세요';
            uploadAreaContent.innerHTML = `
                <div class="spinner" style="width: 50px; height: 50px; border-width: 5px; border-color: #f59e0b; border-top-color: transparent; margin: 0 auto 20px;"></div>
                <div class="upload-text">${uploadingText} (${fileCount}${uploadingCount})</div>
                <div class="upload-hint">${uploadingWait}</div>
            `;

            try {
                // 실제 API 호출
                const formData = new FormData();

                let apiUrl;
                if (isMultipleImages) {
                    // 여러 이미지 파일은 이미지 업로드 API 사용
                    files.forEach(file => {
                        formData.append('images', file);
                    });
                    apiUrl = `${window.API_BASE_URL}/api/documents/upload/images`;
                    console.log('🚀 이미지 API 호출 시작 (여러 파일):', apiUrl, fileCount + '개');
                } else if (allImages) {
                    // 단일 이미지도 이미지 API 사용
                    formData.append('images', files[0]);
                    apiUrl = `${window.API_BASE_URL}/api/documents/upload/images`;
                    console.log('🚀 이미지 API 호출 시작 (단일 파일):', apiUrl);
                } else {
                    // 문서 파일은 문서 업로드 API 사용
                    formData.append('file', files[0]);
                    apiUrl = `${window.API_BASE_URL}/api/documents/upload/files`;
                    console.log('🚀 문서 API 호출 시작:', apiUrl);
                }

                // FormData 사용 시 Authorization 헤더만 추가 (Content-Type은 자동 설정됨)
                const token = localStorage.getItem('accessToken');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: formData,
                    credentials: 'include'
                });

                console.log('📥 응답 상태:', response.status, response.statusText);

                // 응답 텍스트 먼저 확인
                const responseText = await response.text();
                console.log('📥 응답 텍스트:', responseText);

                let result;
                try {
                    result = responseText ? JSON.parse(responseText) : {};
                } catch (jsonError) {
                    console.error('❌ JSON 파싱 실패:', jsonError);
                    throw new Error('서버 응답 형식이 올바르지 않습니다.');
                }

                console.log('📋 응답 데이터:', result);

                if (!response.ok) {
                    const errorMsg = result.error || result.message || '업로드 실패';
                    console.error('❌ 업로드 실패:', errorMsg);
                    throw new Error(errorMsg);
                }

                console.log('✅ 업로드 성공! JobID:', result.data?.jobId);

                // 성공 메시지
                const imageType = window.i18n ? window.i18n.translate('document.fileType.image') : '이미지';
                const documentType = window.i18n ? window.i18n.translate('document.fileType.document') : '문서';
                const uploadingCount = window.i18n ? window.i18n.translate('document.uploadingCount') : '개';
                const fileTypeMsg = allImages ? (isMultipleImages ? `${imageType} ${fileCount}${uploadingCount}` : imageType) : documentType;
                const uploadSuccess = window.i18n ? window.i18n.translate('document.uploadSuccess') : '업로드 완료!';
                const analysisStarted = window.i18n ? window.i18n.translate('document.analysisStarted') : '분석이 시작되었습니다';
                uploadAreaContent.innerHTML = `
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <div class="upload-text" style="color: #10b981;">${uploadSuccess}</div>
                    <div class="upload-hint">${fileTypeMsg} ${analysisStarted} (Job ID: ${result.data?.jobId || 'N/A'})</div>
                `;

                // 선택된 파일 초기화
                selectedFiles = [];

                setTimeout(() => {
                    resetUploadArea();
                    console.log('🔄 문서 목록 새로고침');
                    renderDocuments();
                }, 2000);

            } catch (error) {
                console.error('❌ Upload error:', error);

                // 선택된 파일 초기화
                selectedFiles = [];

                const uploadFailed = window.i18n ? window.i18n.translate('document.uploadFailed') : '업로드 실패';
                const uploadRetry = window.i18n ? window.i18n.translate('document.uploadRetry') : '다시 시도해주세요';
                uploadAreaContent.innerHTML = `
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <div class="upload-text" style="color: #ef4444;">${uploadFailed}</div>
                    <div class="upload-hint" style="color: #ef4444;">${error.message || uploadRetry}</div>
                `;
                setTimeout(resetUploadArea, 3000);
            }
        }

        // 업로드 영역 초기화
        function resetUploadArea() {
            const uploadAreaContent = document.getElementById('uploadAreaContent');
            uploadAreaContent.style.display = 'flex';
            uploadAreaContent.innerHTML = `
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div class="upload-text">파일을 업로드하세요</div>
                <div class="upload-hint">PDF 또는 이미지 파일(JPG, PNG 등)을 지원합니다 (이미지는 여러 개 가능, 최대 10MB)</div>
            `;

            // onclick 핸들러 다시 추가
            uploadAreaContent.onclick = function() {
                document.getElementById('fileInput').click();
            };
        }

        // 요약 보기
        async function viewSummary(jobId) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/documents/${jobId}/summary`, {
                    method: 'GET',
                    headers: window.getAuthHeaders(),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('요약 조회 실패');
                }

                const result = await response.json();
                const summary = result.data.summary;

                // 마크다운을 HTML로 변환
                const htmlContent = marked.parse(summary);

                document.getElementById('modalTitle').textContent = '문서 요약';
                document.getElementById('modalContent').innerHTML = `
                    <div class="markdown-content">
                        ${htmlContent}
                    </div>
                `;
                document.getElementById('summaryModal').classList.add('open');
            } catch (error) {
                console.error('Error fetching summary:', error);
                const errorMsg = window.i18n ? window.i18n.translate('document.error.summaryFetch') : '요약을 불러오는데 실패했습니다.';
                alert(errorMsg);
            }
        }

        // 상태 확인
        async function checkStatus(jobId) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/documents/${jobId}/status`, {
                    method: 'GET',
                    headers: window.getAuthHeaders(),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Status check failed');
                }

                const result = await response.json();
                alert(`${result.data.statusMessage}`);

                // 완료되었으면 목록 새로고침
                if (result.data.statusMessage.includes('완료') || result.data.statusMessage.includes('Completed')) {
                    renderDocuments();
                }
            } catch (error) {
                console.error('Error checking status:', error);
                const errorMsg = window.i18n ? window.i18n.translate('document.error.statusCheck') : '상태를 확인하는데 실패했습니다.';
                alert(errorMsg);
            }
        }

        // 모달 닫기
        function closeSummaryModal() {
            document.getElementById('summaryModal').classList.remove('open');
        }

        // 파일 크기 포맷팅
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // 드래그 앤 드롭
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#d97706';
            uploadArea.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%)';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#f59e0b';
            uploadArea.style.background = 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#f59e0b';
            uploadArea.style.background = 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('fileInput');
                fileInput.files = files;
                showFilePreview({ target: fileInput });
            }
        });

        // 페이지 로드 시 문서 목록 렌더링
        document.addEventListener('DOMContentLoaded', function() {
            renderDocuments();
        });
    </script>

    <script src="/js/i18n.js"></script>
    <script>
        // 페이지 로드 시 로그인 체크 및 언어 적용
        document.addEventListener('DOMContentLoaded', function() {
            // 로그인 체크
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                window.location.href = '/auth/login';
                return;
            }

            // 언어 적용
            if (window.i18n) {
                window.i18n.updatePageLanguage();
            }
        });
    </script>
</body>
</html>
